<!DOCTYPE html>
<html lang="pt-BR" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>NFe Manager - Painel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b1220" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png?v=20260226a" />
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icon-512.png?v=20260226a" />
    <link rel="apple-touch-icon" href="/assets/icon-192.png?v=20260226a" />
    <link rel="shortcut icon" type="image/png" href="/assets/icon-192.png?v=20260226a" />

    <!-- ✅ Tema ANTES de renderizar (evita “piscar”) -->
    <script>
      window.__deferredInstallPrompt = null;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        window.__deferredInstallPrompt = e;
        window.dispatchEvent(new Event("nfse-install-available"));
      });

      (function () {
        try {
          const KEY = "nfseTheme";
          const saved = localStorage.getItem(KEY) || "dark"; // padrÃƒÂ£o: dark (igual ÃƒÂ s imagens)
          const isDark = saved === "dark";
          document.documentElement.classList.toggle("dark", isDark);
        } catch (e) {}
      })();
    </script>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind config -->
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              app: {
                bg: "#060B1A",
                bg2: "#080F24",
                panel: "rgba(255,255,255,0.04)",
                panel2: "rgba(255,255,255,0.06)",
                line: "rgba(255,255,255,0.08)",
                text: "#E7EAF0",
                muted: "rgba(231,234,240,0.65)",
              },
              brand: {
                1: "#6D5EF7",
                2: "#9B6BFF",
                3: "#3B82F6",
                4: "#22C55E",
                5: "#F59E0B",
                6: "#EF4444",
              },
            },
            boxShadow: {
              soft: "0 12px 30px rgba(0,0,0,0.35)",
              glow: "0 0 0 1px rgba(255,255,255,0.06), 0 18px 40px rgba(0,0,0,0.45)",
            },
            borderRadius: {
              xl2: "18px",
            },
          },
        },
      };
    </script>

    <style>
      :root {
        --bg: #f1f4f8;
        --bg2: #edf1f6;
        --panel: #ffffff;
        --panel2: #ffffff;
        --line: #c8d2df;
        --text: #0f172a;
        --muted: #475569;
        --sidebar-bg: #f5f7fb;
        --sidebar-active: #e3e8f0;
        --btn-primary-bg: #101014;
        --btn-primary-text: #ffffff;
      }

      html.dark {
        --bg: #000000;
        --bg2: #000000;
        --panel: #03050a;
        --panel2: #020307;
        --line: #182132;
        --text: #f6f8fb;
        --muted: #9ca8bf;
        --sidebar-bg: #020307;
        --sidebar-active: #1b1f27;
        --btn-primary-bg: #f4f5f7;
        --btn-primary-text: #10131a;
      }

      html,
      body {
        height: 100%;
      }

      body {
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        background:
          radial-gradient(1100px 520px at 10% -20%, rgba(124, 147, 191, 0.12), transparent 58%),
          linear-gradient(180deg, var(--bg), var(--bg2));
        color: var(--text);
        overflow-x: hidden;
      }

      html.dark body {
        background:
          radial-gradient(980px 430px at 15% -10%, rgba(71, 95, 144, 0.18), transparent 60%),
          radial-gradient(980px 450px at 90% 8%, rgba(85, 46, 146, 0.12), transparent 65%),
          linear-gradient(180deg, var(--bg), var(--bg2));
      }

      .min-h-screen.w-full.flex {
        border: 0;
        border-radius: 0;
        overflow: visible;
        min-height: 100vh;
      }

      aside {
        background: var(--sidebar-bg);
        border-right: 1px solid var(--line) !important;
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 248px !important;
        z-index: 40;
      }

      aside > .glass-strong {
        background: transparent !important;
        border: 0 !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        height: 100%;
        padding: 4px 6px !important;
      }

      .sidebar-brand {
        margin-top: 4px;
        margin-bottom: 6px;
        padding-left: 0;
        justify-content: center;
      }

      main {
        background: transparent;
        padding: 22px 22px 30px !important;
        margin-left: 248px;
        width: calc(100% - 248px);
      }

      .glass,
      .glass-strong {
        background: var(--panel);
        border: 1px solid var(--line);
        box-shadow: 0 1px 2px rgba(16, 24, 40, 0.05), 0 7px 18px rgba(16, 24, 40, 0.05);
        backdrop-filter: none;
      }

      html.dark .glass,
      html.dark .glass-strong {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.52);
      }

      .sidebar-item {
        border: 1px solid transparent;
        color: var(--muted);
        border-radius: 12px;
        padding: 9px 11px !important;
        gap: 10px !important;
      }

      .sidebar-item:hover {
        background: var(--sidebar-active);
        border-color: var(--line);
        color: var(--text);
      }

      .sidebar-item.active {
        background: var(--sidebar-active);
        border-color: var(--line);
        color: var(--text);
      }

      .sidebar-item > span:first-child {
        width: 26px;
        height: 26px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: color-mix(in srgb, var(--sidebar-active) 70%, transparent);
      }

      .sidebar-item svg {
        width: 19px;
        height: 19px;
        stroke-width: 1.9;
      }

      .sidebar-item .text-sm.font-medium {
        font-size: 1.02rem;
        font-weight: 600;
      }

      .btn-primary {
        background: var(--btn-primary-bg);
        color: var(--btn-primary-text);
        border: 1px solid transparent;
        font-weight: 600;
      }

      .btn-primary:hover {
        filter: brightness(1.04);
      }

      .btn-install {
        background: linear-gradient(135deg, #10b981, #0ea5e9);
        color: #ffffff;
        border: 1px solid rgba(16, 185, 129, 0.35);
        font-weight: 600;
      }

      .btn-install:hover {
        filter: brightness(1.06);
      }

      html.dark .btn-install {
        background: linear-gradient(135deg, #059669, #0284c7);
        border-color: rgba(5, 150, 105, 0.45);
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid var(--line);
        color: var(--text);
      }

      .btn-ghost:hover {
        background: var(--sidebar-active);
      }

      .field {
        background: var(--panel2);
        border: 1px solid var(--line);
        color: var(--text);
        border-radius: 12px;
      }

      .field::placeholder {
        color: var(--muted);
      }

      .field:focus {
        outline: none;
        border-color: #7c8ba5;
        box-shadow: 0 0 0 3px rgba(124, 139, 165, 0.2);
      }

      html.dark .field:focus {
        box-shadow: 0 0 0 3px rgba(124, 139, 165, 0.25);
      }

      select.field,
      select.field option {
        background-color: var(--panel2);
        color: var(--text);
      }

      #userMenuDropdown {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 14px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      }

      #themeToggleBtn {
        background: var(--panel);
        border: 1px solid var(--line);
      }

      #userMenuBtn {
        background: var(--panel);
        border: 1px solid var(--line);
        min-height: 42px;
      }

      #userAvatar {
        background: color-mix(in srgb, var(--sidebar-active) 85%, transparent) !important;
        border-color: var(--line) !important;
      }

      html.dark #themeToggleBtn,
      html.dark #userMenuBtn {
        background: #06080e;
      }

      #userConfigModal .cfg-modal-shell {
        width: min(760px, 96vw);
        max-height: 82vh;
        overflow: auto;
      }

      #cfgPanelUsers {
        display: grid;
        grid-template-columns: minmax(320px, 1fr) minmax(360px, 1.2fr);
        gap: 18px;
        align-items: start;
        overflow: auto;
        padding-right: 4px;
      }

      #cfgPanelUsers.hidden {
        display: none !important;
      }

      #cfgPanelUsersCreate,
      #cfgPanelUsersList {
        background: var(--panel2);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
      }

      #usersCards {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 12px;
        max-height: none;
      }

      #view-usuarios #cfgPanelUsersList {
        background: color-mix(in srgb, var(--panel) 97%, transparent);
      }

      .crm-user-card {
        position: relative;
        overflow: hidden;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: color-mix(in srgb, var(--panel) 98%, transparent);
        padding: 14px 14px 12px;
        transition: border-color 0.16s ease, box-shadow 0.16s ease;
      }

      .crm-user-card:hover {
        border-color: color-mix(in srgb, var(--line) 70%, var(--text) 30%);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.1);
      }

      html.dark .crm-user-card:hover {
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.34);
      }

      .crm-user-head {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .crm-user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.02em;
        border: 1px solid var(--line);
        color: var(--text);
        background: color-mix(in srgb, var(--panel2) 84%, transparent);
      }

      .crm-user-name {
        font-size: 1.02rem;
        line-height: 1.15;
        font-weight: 700;
        color: var(--text);
      }

      .crm-user-sub {
        margin-top: 3px;
        font-size: 0.8rem;
        color: var(--muted);
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .crm-user-meta {
        margin-top: 11px;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 9px;
      }

      .crm-user-meta-item {
        border: 1px solid var(--line);
        border-radius: 9px;
        padding: 7px 9px;
        background: color-mix(in srgb, var(--panel2) 92%, transparent);
      }

      .crm-user-meta-label {
        font-size: 0.68rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .crm-user-meta-value {
        margin-top: 3px;
        font-size: 0.84rem;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .crm-user-contact {
        margin-top: 10px;
        border-top: 1px solid color-mix(in srgb, var(--line) 86%, transparent);
        padding-top: 9px;
        display: grid;
        gap: 4px;
      }

      .crm-user-contact p {
        font-size: 0.81rem;
        color: color-mix(in srgb, var(--text) 88%, transparent);
      }

      .crm-user-actions {
        margin-top: 11px;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 7px;
      }

      .crm-user-actions button {
        min-height: 30px;
      }

      .crm-stats {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 8px;
      }

      .crm-stat-chip {
        border: 1px solid var(--line);
        border-radius: 11px;
        background: color-mix(in srgb, var(--panel2) 94%, transparent);
        padding: 8px 10px;
        text-align: left;
        transition: border-color 0.15s ease, background 0.15s ease;
      }

      .crm-stat-chip:hover {
        border-color: color-mix(in srgb, var(--line) 70%, var(--text) 30%);
      }

      .crm-stat-chip.active {
        border-color: color-mix(in srgb, var(--line) 55%, var(--text) 45%);
        background: color-mix(in srgb, var(--panel) 86%, transparent);
      }

      .crm-stat-label {
        display: block;
        font-size: 0.68rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .crm-stat-value {
        display: block;
        margin-top: 2px;
        font-size: 0.96rem;
        font-weight: 700;
        color: var(--text);
      }

      .crm-top-cards {
        margin-top: 14px;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 10px;
      }

      .crm-top-cards .crm-stat-chip {
        border-radius: 14px;
        min-height: 78px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .crm-segment-tabs {
        margin-top: 14px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .crm-tab-btn {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: color-mix(in srgb, var(--panel2) 94%, transparent);
        color: var(--text);
        padding: 8px 14px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .crm-tab-btn.active {
        background: color-mix(in srgb, var(--sidebar-active) 86%, transparent);
      }

      .crm-filter-panel {
        margin-top: 12px;
        border: 1px solid var(--line);
        border-radius: 16px;
        background: color-mix(in srgb, var(--panel2) 94%, transparent);
        padding: 14px;
      }

      .crm-users-table-wrap {
        border: 1px solid var(--line);
        border-radius: 16px;
        overflow: visible;
        background: color-mix(in srgb, var(--panel2) 95%, transparent);
      }

      .crm-users-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .crm-users-table thead th {
        text-align: left;
        font-size: 0.83rem;
        letter-spacing: 0.02em;
        color: var(--muted);
        font-weight: 600;
        padding: 12px 10px;
        border-bottom: 1px solid var(--line);
      }

      .crm-users-table tbody td {
        padding: 12px 10px;
        border-bottom: 1px solid color-mix(in srgb, var(--line) 88%, transparent);
        vertical-align: middle;
      }

      .crm-users-table tbody tr:last-child td {
        border-bottom: 0;
      }

      .crm-plan-pill {
        display: inline-flex;
        align-items: center;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.78rem;
        font-weight: 600;
      }

      .crm-pass-cell {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .crm-pass-eye {
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 0;
      }

      .crm-action-menu {
        position: relative;
      }

      .crm-action-menu-list {
        position: absolute;
        right: 0;
        top: 30px;
        min-width: 170px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: var(--panel);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.24);
        padding: 6px;
        z-index: 12;
      }

      .crm-users-table tbody td:last-child {
        overflow: visible;
      }

      .crm-action-menu-list button {
        width: 100%;
        text-align: left;
        border: 0;
        border-radius: 9px;
        background: transparent;
        color: var(--text);
        padding: 8px 10px;
        font-size: 0.84rem;
      }

      .crm-action-menu-list button:hover {
        background: var(--sidebar-active);
      }

      @media (max-width: 980px) {
        .crm-user-meta {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .crm-stats {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .crm-top-cards {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 860px) {
        .crm-users-table-wrap {
          overflow-x: auto;
          overflow-y: visible;
        }
        .crm-users-table {
          min-width: 940px;
        }
      }

      #logoutBtn {
        color: #dc2626;
      }

      html.dark #logoutBtn {
        color: #f87171;
      }

      @media (max-width: 1100px) {
        #cfgPanelUsers {
          grid-template-columns: 1fr;
        }
      }

      .modal-backdrop {
        background: rgba(11, 18, 32, 0.45);
        backdrop-filter: blur(3px);
      }

      aside .text-base.font-semibold {
        font-size: 1.8rem;
        letter-spacing: -0.01em;
      }

      aside .text-\[11px\].uppercase {
        font-size: 0.72rem;
        letter-spacing: 0.16em;
      }

      @media (max-width: 1360px) {
        main {
          padding: 18px 16px 24px !important;
        }

        .sidebar-item .text-sm.font-medium {
          font-size: 0.98rem;
        }
      }

      @media (max-width: 980px) {
        aside {
          width: 224px !important;
        }
        main {
          margin-left: 224px;
          width: calc(100% - 224px);
        }
      }

      @media (max-width: 860px) {
        .min-h-screen.w-full.flex {
          display: block;
        }

        aside {
          position: fixed;
          left: 0;
          top: 0;
          bottom: 0;
          width: min(86vw, 340px) !important;
          border-right: 1px solid var(--line) !important;
          border-bottom: 0 !important;
          transform: translateX(-102%);
          transition: transform 0.25s ease;
          z-index: 80;
          box-shadow: 0 18px 46px rgba(0, 0, 0, 0.35);
        }

        aside > .glass-strong {
          height: 100%;
          padding: 10px 12px !important;
        }

        .sidebar-item {
          min-height: 44px;
        }

        body.mobile-menu-open aside {
          transform: translateX(0);
        }

        #mobileMenuBackdrop {
          position: fixed;
          inset: 0;
          background: rgba(2, 8, 23, 0.45);
          backdrop-filter: blur(2px);
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
          z-index: 70;
        }

        body.mobile-menu-open #mobileMenuBackdrop {
          opacity: 1;
          pointer-events: auto;
        }

        body.mobile-menu-open {
          overflow: hidden;
        }

        .sidebar-brand {
          justify-content: flex-start;
          gap: 8px;
        }

        #mobileMenuCloseBtn {
          display: inline-flex !important;
        }

        #mobileMenuToggleBtn {
          display: inline-flex !important;
        }

        main {
          margin-left: 0;
          width: 100%;
          padding: 14px 12px 20px !important;
        }

        #topBar {
          flex-direction: row;
          align-items: center;
          gap: 10px;
        }

        #topBarTitleWrap {
          display: flex;
          align-items: center;
          gap: 10px;
          min-width: 0;
          flex: 1;
        }

        #topBarActions {
          width: auto;
          justify-content: flex-end;
          flex-wrap: wrap;
        }

        #pageTitle {
          font-size: 1.6rem;
        }
      }

      @media (max-width: 560px) {
        .sidebar-item .text-sm.font-medium {
          font-size: 0.95rem;
        }

        #pageTitle {
          font-size: 1.35rem;
        }

        #pageSubtitle {
          font-size: 0.82rem;
        }
      }

      #view-dashboard .glass.rounded-xl2.p-5,
      #view-dashboard .glass-strong.rounded-xl2.p-5 {
        min-height: 120px;
      }

      #view-empresas .glass.rounded-xl2.p-5,
      #view-downloads .glass.rounded-xl2.p-5,
      #view-historico .glass.rounded-xl2.p-5 {
        border-radius: 16px;
      }

      html.dark .text-white\/55,
      html.dark .text-white\/50,
      html.dark .text-white\/45,
      html.dark .text-white\/40 {
        color: var(--muted) !important;
      }

      html:not(.dark) .text-white\/55,
      html:not(.dark) .text-white\/50,
      html:not(.dark) .text-white\/45,
      html:not(.dark) .text-white\/40 {
        color: var(--muted) !important;
      }

      html:not(.dark) .text-white,
      html:not(.dark) .text-white\/90,
      html:not(.dark) .text-white\/85,
      html:not(.dark) .text-white\/80 {
        color: var(--text) !important;
      }

      html:not(.dark) .text-white\/75,
      html:not(.dark) .text-white\/70,
      html:not(.dark) .text-white\/65,
      html:not(.dark) .text-white\/60 {
        color: var(--muted) !important;
      }

      html:not(.dark) .glass svg [stroke="white"],
      html:not(.dark) .glass-strong svg [stroke="white"] {
        stroke: #334155 !important;
      }
    </style>
  </head>

  <body>
    <div class="min-h-screen w-full flex">
      <!-- =========================
           SIDEBAR (igual ÃƒÂ s imagens)
      ========================== -->
      <aside class="shrink-0 border-r border-white/5 flex">
        <div class="glass-strong rounded-xl2 p-4 w-full flex flex-col">
          <div class="flex items-center sidebar-brand">
            <img
              src="/assets/fluxonf-logo.png?v=20260226a"
              alt="Fluxo NF - Captura e Organização de NFS-e"
              class="block h-auto w-full max-w-[172px] object-contain"
              onerror="if(!this.dataset.fallback){this.dataset.fallback='1';this.src='/fluxonf-logo.png?v=20260226a';return;}this.style.display='none';"
            />
            <span class="ml-2 inline-flex items-center rounded-full border border-white/15 px-2 py-0.5 text-[10px] font-semibold tracking-wide text-white/70">
              v2.0.0
            </span>
            <button id="mobileMenuCloseBtn" class="btn-ghost h-10 w-10 rounded-full hidden items-center justify-center ml-auto" type="button" title="Fechar menu">
              <span class="text-white/80 text-xl leading-none">&times;</span>
            </button>
          </div>

          <div class="mt-1.5 h-px bg-white/5"></div>

          <nav class="mt-2 space-y-1 flex-1">
            <button class="sidebar-item active w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-dashboard">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M4 13h7V4H4v9Zm0 7h7v-5H4v5Zm9 0h7V11h-7v9Zm0-18v7h7V2h-7Z" stroke="currentColor" stroke-width="1.8" />
                </svg>
              </span>
              <span class="text-sm font-medium">Dashboard</span>
              <span class="ml-auto text-white/30">&rsaquo;</span>
            </button>

            <button class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-empresas">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M4 20V6a2 2 0 0 1 2-2h6v16H4Zm10 0V4h4a2 2 0 0 1 2 2v14h-6Z" stroke="currentColor" stroke-width="1.8" />
                  <path d="M7 8h2M7 12h2M7 16h2" stroke="currentColor" stroke-width="1.8" opacity="0.65" />
                </svg>
              </span>
              <span class="text-sm font-medium">Empresas</span>
              <span class="ml-auto text-white/30">&rsaquo;</span>
            </button>

            <button class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-captura-lote">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M7 7h10v4H7V7Z" stroke="currentColor" stroke-width="1.8" />
                  <path d="M7 13h10v4H7v-4Z" stroke="currentColor" stroke-width="1.8" opacity="0.85" />
                  <path d="M7 19h10" stroke="currentColor" stroke-width="1.8" opacity="0.5" />
                </svg>
              </span>
              <span class="text-sm font-medium">Captura de Notas</span>
              <span class="ml-auto text-white/30">&rsaquo;</span>
            </button>

            <button class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-fila">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M6 7h12M6 12h12M6 17h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                  <path d="M4 7h.01M4 12h.01M4 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                </svg>
              </span>
              <span class="text-sm font-medium">Fila de Captura</span>
              <span class="ml-auto text-white/30">&rsaquo;</span>
            </button>

            <button class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-downloads">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3v10m0 0 3-3m-3 3-3-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M5 17v3h14v-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                </svg>
              </span>
              <span class="text-sm font-medium">Downloads</span>
              <span class="ml-auto text-white/30">&rsaquo;</span>
            </button>

            <button class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-historico">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M12 8v5l3 2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                  <path d="M21 12a9 9 0 1 1-3-6.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                </svg>
              </span>
              <span class="text-sm font-medium">Histórico / Logs</span>
              <span class="ml-auto text-white/30">&rsaquo;</span>
            </button>

            <button class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-emissao">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M7 4h10v16H7V4Z" stroke="currentColor" stroke-width="1.8" />
                  <path d="M9 8h6M9 12h6M9 16h4" stroke="currentColor" stroke-width="1.8" opacity="0.75" stroke-linecap="round" />
                </svg>
              </span>
              <span class="text-sm font-medium">Emissão NF-e</span>
              <span class="ml-auto text-white/30">&rsaquo;</span>
            </button>

            <div id="adminMenuBlock">
              <div class="px-2 pt-2 pb-1">
                <p class="text-[11px] uppercase tracking-[0.16em] text-white/45">Administração</p>
              </div>

              <button class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl2 text-left" data-view="view-usuarios">
                <span class="text-white/70">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M16 20v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    <circle cx="9" cy="7" r="3" stroke="currentColor" stroke-width="1.8" />
                    <path d="M20 8v6M23 11h-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                  </svg>
                </span>
                <span class="text-sm font-medium">Usuários</span>
                <span class="ml-auto text-white/30">&rsaquo;</span>
              </button>
            </div>
          </nav>

          <div class="mt-2 h-px bg-white/5"></div>

          <div class="mt-auto rounded-xl2 p-4 glass">
            <p class="text-[13px] font-semibold text-white/80">Notas Fiscais</p>
            <p class="text-[12px] text-white/45 mt-1.5">Captura • Organização</p>
          </div>
        </div>
      </aside>
      <div id="mobileMenuBackdrop" aria-hidden="true"></div>

      <!-- =========================
           CONTEÃƒÅ¡DO
      ========================== -->
      <main class="flex-1 p-6 lg:p-8">
        <!-- Top bar (tÃƒÂ­tulo + aÃƒÂ§ÃƒÂµes) -->
        <div id="topBar" class="flex items-start justify-between gap-4">
          <div id="topBarTitleWrap">
            <button id="mobileMenuToggleBtn" class="btn-ghost h-11 w-11 rounded-full hidden items-center justify-center shrink-0" type="button" title="Abrir menu">
              <span class="text-white/80 text-lg leading-none">☰</span>
            </button>
            <div>
            <h1 id="pageTitle" class="text-3xl font-semibold tracking-tight">Dashboard</h1>
            <p id="pageSubtitle" class="mt-1 text-sm text-white/55">Visão geral do sistema de notas fiscais</p>
            </div>
          </div>

          <div id="topBarActions" class="flex items-center gap-3">
            <div id="clientPlanBadge" class="hidden glass-strong rounded-full px-3 py-2 text-xs font-semibold"></div>
            <button id="installAppBtn" class="btn-install h-11 px-4 rounded-full text-sm inline-flex items-center gap-2" title="Instalar aplicativo">
              <span class="inline-flex h-4 w-4 items-center justify-center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3v10m0 0 3-3m-3 3-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M5 17v3h14v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <span>Instalar App</span>
            </button>
            <button id="themeToggleBtn" class="btn-ghost h-11 w-11 rounded-full text-sm inline-flex items-center justify-center" title="Alternar tema">
              <span class="text-white/70">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M21 14.5A8.5 8.5 0 0 1 9.5 3a7 7 0 1 0 11.5 11.5Z" stroke="currentColor" stroke-width="1.8" />
                </svg>
              </span>
            </button>

            <!-- Usuário -->
            <div class="relative">
              <button id="userMenuBtn" class="glass-strong rounded-full px-3 py-2 flex items-center gap-3">
                <div
                  id="userAvatar"
                  class="h-8 w-8 rounded-full flex items-center justify-center text-xs font-semibold"
                  style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1)"
                >
                  ?
                </div>
                <div class="leading-tight text-left hidden md:block">
                  <p class="text-[10px] uppercase tracking-[0.14em] text-white/45">Usuário</p>
                  <p id="userNameDisplay" class="text-sm font-medium text-white/85">...</p>
                </div>
                <span class="text-white/45">&rsaquo;</span>
              </button>

              <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-[220px] glass-strong rounded-xl2 p-2 z-50">
                <button id="userConfigBtn" class="w-full text-left px-3 py-2 rounded-xl2 text-sm hover:bg-white/10">Meu Perfil</button>
                <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-xl2 text-sm hover:bg-white/10">Sair</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ====== VIEWS ====== -->

        <!-- =========================
             VIEW: DASHBOARD
        ========================== -->
        <section id="view-dashboard" class="mt-6 space-y-6">
          <!-- KPI cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <!-- Empresas -->
            <button type="button" id="kpiCardEmpresas" class="glass-strong rounded-xl2 p-5 flex items-center justify-between w-full text-left hover:brightness-105 transition" data-jump="view-empresas">
              <div>
                <p class="text-xs uppercase tracking-[0.18em] text-white/45">Empresas</p>
                <p id="kpiEmpresas" class="mt-2 text-3xl font-semibold">3</p>
              </div>
              <div
                class="h-10 w-10 rounded-xl2 flex items-center justify-center"
                style="
                  background: radial-gradient(circle at 30% 30%, rgba(109, 94, 247, 0.4), rgba(255, 255, 255, 0.03));
                  border: 1px solid rgba(255, 255, 255, 0.08);
                "
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M4 20V6a2 2 0 0 1 2-2h6v16H4Zm10 0V4h4a2 2 0 0 1 2 2v14h-6Z" stroke="white" stroke-width="1.8" opacity="0.9" />
                </svg>
              </div>
            </button>

            <!-- Capturas concluídas -->
            <button
              type="button"
              id="kpiCardConcluidas"
              class="glass-strong rounded-xl2 p-5 flex items-center justify-between w-full text-left hover:brightness-105 transition"
              data-jump="view-historico"
              data-historico-filtro="Sucesso"
              style="background: radial-gradient(420px 220px at 10% 20%, rgba(34, 197, 94, 0.14), transparent 60%), var(--panel2)"
            >
              <div>
                <p class="text-xs uppercase tracking-[0.18em] text-white/45">Capturas concluídas</p>
                <p id="kpiConcluidas" class="mt-2 text-3xl font-semibold">0</p>
              </div>
              <div class="h-10 w-10 rounded-xl2 flex items-center justify-center" style="background: rgba(34, 197, 94, 0.12); border: 1px solid rgba(34, 197, 94, 0.25)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6 9 17l-5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
            </button>

            <!-- Na fila -->
            <button
              type="button"
              id="kpiCardFila"
              class="glass-strong rounded-xl2 p-5 flex items-center justify-between w-full text-left hover:brightness-105 transition"
              data-jump="view-fila"
              style="background: radial-gradient(420px 220px at 10% 20%, rgba(245, 158, 11, 0.14), transparent 60%), var(--panel2)"
            >
              <div>
                <p class="text-xs uppercase tracking-[0.18em] text-white/45">Na fila</p>
                <p id="kpiFila" class="mt-2 text-3xl font-semibold">0</p>
              </div>
              <div class="h-10 w-10 rounded-xl2 flex items-center justify-center" style="background: rgba(245, 158, 11, 0.12); border: 1px solid rgba(245, 158, 11, 0.25)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2 2 7l10 5 10-5-10-5Zm0 10L2 7v10l10 5 10-5V7l-10 5Z" stroke="white" stroke-width="1.6" opacity="0.95" />
                </svg>
              </div>
            </button>

            <!-- Erros -->
            <button
              type="button"
              id="kpiCardErros"
              class="glass-strong rounded-xl2 p-5 flex items-center justify-between w-full text-left hover:brightness-105 transition"
              data-jump="view-historico"
              data-historico-filtro="Erro"
              style="background: radial-gradient(420px 220px at 10% 20%, rgba(239, 68, 68, 0.14), transparent 60%), var(--panel2)"
            >
              <div>
                <p class="text-xs uppercase tracking-[0.18em] text-white/45">Erros</p>
                <p id="kpiErros" class="mt-2 text-3xl font-semibold">0</p>
              </div>
              <div class="h-10 w-10 rounded-xl2 flex items-center justify-center" style="background: rgba(239, 68, 68, 0.12); border: 1px solid rgba(239, 68, 68, 0.25)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M12 9v4m0 4h.01" stroke="white" stroke-width="2" stroke-linecap="round" />
                  <path d="M10.3 3.6h3.4L22 18.1a2 2 0 0 1-1.7 3H3.7A2 2 0 0 1 2 18.1L10.3 3.6Z" stroke="white" stroke-width="1.6" opacity="0.9" />
                </svg>
              </div>
            </button>
          </div>

          <!-- Recentes + Logs -->
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-5">
            <div class="glass rounded-xl2 p-5 min-h-[240px]">
              <div class="flex items-center justify-between">
                <h3 class="text-base font-semibold">Capturas Recentes</h3>
                <button class="text-sm text-white/55 hover:text-white/80" data-jump="view-fila">Ver todas →</button>
              </div>
              <div id="dashboardRecentesContainer" class="mt-4 space-y-3"></div>
              <div id="dashboardRecentesEmpty" class="mt-8 text-center text-white/45">
                <p class="text-sm">Nenhuma captura ainda</p>
              </div>
            </div>

            <div class="glass rounded-xl2 p-5 min-h-[240px]">
              <div class="flex items-center justify-between">
                <h3 class="text-base font-semibold">Últimos Logs</h3>
                <button class="text-sm text-white/55 hover:text-white/80" data-jump="view-historico">Ver todos →</button>
              </div>
              <div id="dashboardLogsContainer" class="mt-4 space-y-3"></div>
              <div id="dashboardLogsEmpty" class="mt-8 text-center text-white/45 hidden">
                <p class="text-sm">Nenhum log ainda</p>
              </div>
            </div>
          </div>

          <!-- AÃƒÂ§ÃƒÂµes rÃƒÂ¡pidas -->
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <button class="glass rounded-xl2 p-5 text-left hover:brightness-110 transition" data-jump="view-empresas">
              <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl2 flex items-center justify-center" style="background: rgba(109, 94, 247, 0.12); border: 1px solid rgba(109, 94, 247, 0.25)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M4 20V6a2 2 0 0 1 2-2h6v16H4Zm10 0V4h4a2 2 0 0 1 2 2v14h-6Z" stroke="white" stroke-width="1.8" opacity="0.9" />
                  </svg>
                </div>
                <div>
                  <p class="text-sm font-semibold">Nova Empresa</p>
                  <p class="text-xs text-white/50">Cadastrar empresa</p>
                </div>
              </div>
            </button>

            <button class="glass rounded-xl2 p-5 text-left hover:brightness-110 transition" data-jump="view-captura-lote">
              <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl2 flex items-center justify-center" style="background: rgba(34, 197, 94, 0.12); border: 1px solid rgba(34, 197, 94, 0.25)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M7 7h10v10H7V7Z" stroke="white" stroke-width="1.8" />
                    <path d="M12 10v4m0 0 2-2m-2 2-2-2" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </div>
                <div>
                  <p class="text-sm font-semibold">Captura de Nota</p>
                  <p class="text-xs text-white/50">Solicitar captura</p>
                </div>
              </div>
            </button>

            <button class="glass rounded-xl2 p-5 text-left hover:brightness-110 transition" data-jump="view-emissao">
              <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl2 flex items-center justify-center" style="background: rgba(245, 158, 11, 0.12); border: 1px solid rgba(245, 158, 11, 0.25)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M7 4h10v16H7V4Z" stroke="white" stroke-width="1.8" />
                    <path d="M9 8h6M9 12h6M9 16h4" stroke="white" stroke-width="1.8" opacity="0.75" stroke-linecap="round" />
                  </svg>
                </div>
                <div>
                  <p class="text-sm font-semibold">Emitir NF-e</p>
                  <p class="text-xs text-white/50">Nova emissão</p>
                </div>
              </div>
            </button>
          </div>
        </section>

        <!-- =========================
             VIEW: EMPRESAS (com modal)
        ========================== -->
        <section id="view-empresas" class="mt-6 space-y-6 hidden">
          <div class="glass rounded-xl2 p-4">
            <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
              <div class="relative w-full lg:flex-1">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/45">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M10.8 18.2a7.4 7.4 0 1 1 0-14.8 7.4 7.4 0 0 1 0 14.8Z" stroke="currentColor" stroke-width="1.8" />
                  </svg>
                </span>
                <input id="empresasSearch" class="field w-full rounded-xl2 px-12 py-3 text-sm" placeholder="Buscar por nome, CNPJ ou razão social..." />
              </div>
              <button id="btnNovaEmpresa" class="btn-primary h-11 min-w-[178px] px-5 rounded-xl2 text-sm font-semibold inline-flex items-center justify-center gap-2 w-full lg:w-auto shrink-0 whitespace-nowrap leading-none">
                <span class="text-white inline-flex h-4 w-4 items-center justify-center leading-none">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </span>
                <span class="inline-flex items-center leading-none">Nova Empresa</span>
              </button>
            </div>

            <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-3" id="empresasGrid">
              <!-- cards preenchidos via JS -->
            </div>
          </div>

          <!-- Modal (Cadastrar Empresa) -->
          <div id="modalEmpresa" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
            <div class="modal-backdrop absolute inset-0"></div>

            <div class="relative w-full max-w-[760px] glass-strong rounded-xl2 p-6">
              <div class="flex items-center justify-between">
                <h3 class="text-xl font-semibold" id="modalEmpresaTitle">Cadastrar Empresa</h3>
                <button id="modalEmpresaClose" class="text-white/55 hover:text-white/85">✕</button>
              </div>

              <div class="mt-6 space-y-4">
                <!-- hidden id (ediÃƒÂ§ÃƒÂ£o) -->
                <input id="empresaId" type="hidden" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-white/80">Nome Fantasia</label>
                    <input id="empresaNome" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Nome Fantasia" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-white/80">CNPJ</label>
                    <input id="empresaCnpj" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="00.000.000/0000-00" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-white/80">Razão Social</label>
                    <input id="empresaRazaoSocial" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Razão Social" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-white/80">Inscrição Estadual</label>
                    <input id="empresaIe" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Inscrição Estadual" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-white/80">UF</label>
                    <select id="empresaUf" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                      <option value="">Selecione</option>
                      <option>PR</option>
                      <option>SC</option>
                      <option>SP</option>
                      <option>RJ</option>
                      <option>MG</option>
                      <option>ES</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-white/80">Cidade</label>
                    <input id="empresaCidade" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Cidade" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-white/80">Endereço</label>
                    <input id="empresaEndereco" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Endereço" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-white/80">Telefone</label>
                    <input id="empresaTelefone" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="(11) 99999-0000" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-white/80">E-mail</label>
                    <input id="empresaEmail" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="contato@empresa.com.br" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-white/80">Status</label>
                    <select id="empresaStatus" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                      <option value="ATIVO">Ativo</option>
                      <option value="INATIVO">Inativo</option>
                    </select>
                  </div>
                </div>

                <div class="pt-2 border-t border-white/10">
                  <label class="text-sm font-semibold text-white/80">Método de Autenticação</label>
                  <select id="empresaAuthType" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                    <option>Login e Senha</option>
                    <option>Certificado Digital (A1)</option>
                  </select>
                </div>

                <div id="empresaAuthLoginBlock" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-white/80">Login</label>
                    <input id="empresaLogin" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Usuário" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-white/80">Senha</label>
                    <div class="relative mt-2">
                      <input id="empresaSenha" type="password" class="field w-full rounded-xl2 px-4 py-3 text-sm pr-12" placeholder="••••••" />
                      <button id="toggleEmpresaSenha" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/55 hover:text-white/85" type="button"> 👁 </button>
                    </div>
                  </div>
                </div>

                <div id="empresaAuthCertBlock" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-white/80">Arquivo do Certificado A1</label>
                    <input id="empresaCertFile" type="file" accept=".pfx,.p12,.pem,.cer,.crt,.key,application/x-pkcs12,application/pkcs12" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                    <p id="empresaCertCurrent" class="mt-1 text-xs text-white/55"></p>
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-white/80">Senha Certificado</label>
                    <input id="empresaCertPass" type="password" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Senha do certificado" />
                  </div>
                </div>
              </div>

              <div class="mt-6 flex items-center justify-end gap-3">
                <button id="modalEmpresaCancel" class="btn-ghost px-5 py-3 rounded-xl2 text-sm">Cancelar</button>
                <button id="modalEmpresaSave" class="btn-primary px-6 py-3 rounded-xl2 text-sm font-semibold">Cadastrar</button>
              </div>
            </div>
          </div>
        </section>

        <!-- =========================
             VIEW: CAPTURA DE NOTAS (unificada)
        ========================== -->
        <section id="view-captura-lote" class="mt-6 space-y-6 hidden">
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-5">
            <!-- Selecionar empresas -->
            <div class="glass rounded-xl2 p-5">
              <div class="flex items-center justify-between">
                <h3 class="text-base font-semibold">Selecionar Empresas</h3>
                <button id="btnSelecionarTodasLote" class="text-sm text-white/55 hover:text-white/80">Selecionar todas</button>
              </div>

              <div class="mt-4 space-y-3" id="loteEmpresasList">
                <!-- preenchido via JS -->
              </div>
            </div>

            <!-- Filtros -->
            <div class="glass rounded-xl2 p-5">
              <h3 class="text-base font-semibold">Filtros da Captura</h3>

              <div class="mt-5">
                <p class="text-xs uppercase tracking-[0.18em] text-white/45">Período (máx. 30 dias)</p>

                <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-white/70">Data Início</label>
                    <input id="loteDataInicio" type="date" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                  <div>
                    <label class="text-sm text-white/70">Data Fim</label>
                    <input id="loteDataFim" type="date" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                </div>
              </div>

              <div class="mt-6">
                <p class="text-xs uppercase tracking-[0.18em] text-white/45">Tipos de nota</p>
                <div class="mt-3 flex flex-wrap gap-4 text-sm">
                  <label class="inline-flex items-center gap-2">
                    <input id="loteTipoRecebidas" type="checkbox" checked class="h-4 w-4 accent-[rgb(109,94,247)]" />
                    Recebidas
                  </label>
                  <label class="inline-flex items-center gap-2">
                    <input id="loteTipoEmitidas" type="checkbox" checked class="h-4 w-4 accent-[rgb(109,94,247)]" />
                    Emitidas
                  </label>
                  <label class="inline-flex items-center gap-2">
                    <input id="loteTipoCanceladas" type="checkbox" checked class="h-4 w-4 accent-[rgb(109,94,247)]" />
                    Canceladas
                  </label>
                </div>
              </div>

              <div class="mt-6">
                <p class="text-xs uppercase tracking-[0.18em] text-white/45">Formato</p>
                <select id="loteFormato" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-3">
                  <option>PDF + XML</option>
                  <option>Somente XML</option>
                  <option>Somente PDF</option>
                </select>
              </div>

              <button
                id="btnCapturarLote"
                class="mt-6 w-full btn-primary px-5 py-4 rounded-xl2 text-sm font-semibold flex items-center justify-center gap-2 opacity-70"
                disabled
              >
                <span class="text-white/90">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2 2 7l10 5 10-5-10-5Zm0 10L2 7v10l10 5 10-5V7l-10 5Z" stroke="currentColor" stroke-width="1.6" />
                  </svg>
                </span>
                <span id="labelCapturarLote">Capturar 0 Empresa(s)</span>
              </button>
            </div>
          </div>
        </section>

        <!-- =========================
             VIEW: FILA
        ========================== -->
        <section id="view-fila" class="mt-6 space-y-6 hidden">
          <div id="filaContainer" class="glass rounded-xl2 p-6 min-h-[360px] flex items-center justify-center">
            <div class="text-center text-white/45">
              <div class="mx-auto mb-3 text-white/35">
                <svg width="34" height="34" viewBox="0 0 24 24" fill="none">
                  <path d="M6 7h12M6 12h12M6 17h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M4 7h.01M4 12h.01M4 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                </svg>
              </div>
              <p class="text-sm">Nenhuma captura na fila</p>
            </div>
          </div>
        </section>

        <!-- =========================
             VIEW: DOWNLOADS
        ========================== -->
        <section id="view-downloads" class="mt-6 space-y-6 hidden">
  <div id="downloadsContainer" class="glass rounded-xl2 p-6 min-h-[420px]"></div>
</section>

        <!-- =========================
             VIEW: HISTÓRICO / LOGS
        ========================== -->
        <section id="view-historico" class="mt-6 space-y-6 hidden">
          <div class="glass rounded-xl2 p-5">
            <div class="flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div class="relative flex-1">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/45">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M10.8 18.2a7.4 7.4 0 1 1 0-14.8 7.4 7.4 0 0 1 0 14.8Z" stroke="currentColor" stroke-width="1.8" />
                  </svg>
                </span>
                <input id="historicoSearch" class="field w-full rounded-xl2 px-12 py-3 text-sm" placeholder="Buscar nos logs..." />
              </div>

              <select id="historicoFiltro" class="field rounded-xl2 px-4 py-3 text-sm w-full lg:w-[200px]">
                <option>Todos</option>
                <option>Info</option>
                <option>Sucesso</option>
                <option>Erro</option>
              </select>
            </div>

            <div class="mt-5 space-y-3" id="historicoList">
              <div class="glass-strong rounded-xl2 p-5">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background: rgba(59, 130, 246, 0.14); border: 1px solid rgba(59, 130, 246, 0.28)"> Info </span>
                    <div>
                      <p class="text-sm font-semibold">Captura individual solicitada para Tech Solutions Ltda</p>
                      <p class="text-xs text-white/45 mt-1">Período: 2026-01-01 a 2026-01-30 | Tipos: recebidas, emitidas | Formato: ambos</p>
                      <p class="text-xs text-white/35 mt-2">Tech Solutions Ltda • 12.345.678/0001-90 • captura_individual</p>
                    </div>
                  </div>
                  <span class="text-xs text-white/45">23/02/2026 15:47:28</span>
                </div>
              </div>

              <div class="glass-strong rounded-xl2 p-5">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background: rgba(34, 197, 94, 0.14); border: 1px solid rgba(34, 197, 94, 0.28)"> Sucesso </span>
                    <div>
                      <p class="text-sm font-semibold">Captura concluída para Tech Solutions Ltda - 23 notas capturadas</p>
                      <p class="text-xs text-white/45 mt-1">Período: 2026-01-01 a 2026-01-30</p>
                      <p class="text-xs text-white/35 mt-2">Tech Solutions Ltda • 12.345.678/0001-90 • captura_concluida</p>
                    </div>
                  </div>
                  <span class="text-xs text-white/45">23/02/2026 15:47:28</span>
                </div>
              </div>

              <div class="glass-strong rounded-xl2 p-5">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background: rgba(59, 130, 246, 0.14); border: 1px solid rgba(59, 130, 246, 0.28)"> Info </span>
                    <div>
                      <p class="text-sm font-semibold">Captura em lote solicitada para 3 empresa(s)</p>
                      <p class="text-xs text-white/45 mt-1">Lote: LOTE-001 | Período: 2026-02-01 a 2026-02-28</p>
                      <p class="text-xs text-white/35 mt-2">captura_lote</p>
                    </div>
                  </div>
                  <span class="text-xs text-white/45">23/02/2026 15:47:28</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- =========================
             VIEW: EMISSÃƒÆ’O
        ========================== -->
        <section id="view-emissao" class="mt-6 space-y-6 hidden">
          <div class="glass rounded-xl2 p-0 overflow-hidden">
            <div class="p-6">
              <div class="flex items-center justify-between">
                <h3 class="text-xl font-semibold">Nova Emissão NF-e</h3>
                <button class="btn-primary px-5 py-3 rounded-xl2 text-sm font-semibold flex items-center gap-2">
                  <span>+</span> Nova Emissão
                </button>
              </div>

              <div class="mt-6 space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <p class="text-xs font-semibold text-white/55 uppercase tracking-[0.18em]">Emitente</p>
                    <label class="text-sm text-white/70 mt-3 block">Empresa</label>
                    <select class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                      <option>Selecione a empresa</option>
                    </select>
                  </div>

                  <div>
                    <p class="text-xs font-semibold text-white/55 uppercase tracking-[0.18em]">Autenticação</p>
                    <label class="text-sm text-white/70 mt-3 block">&nbsp;</label>
                    <select class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                      <option>Login e Senha</option>
                      <option>Certificado Digital (A1)</option>
                    </select>
                  </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <p class="text-xs font-semibold text-white/55 uppercase tracking-[0.18em]">Destinatário</p>
                    <label class="text-sm text-white/70 mt-3 block">Nome / Razão Social</label>
                    <input class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>

                  <div>
                    <p class="text-xs font-semibold text-white/55 uppercase tracking-[0.18em]">&nbsp;</p>
                    <label class="text-sm text-white/70 mt-3 block">CNPJ / CPF</label>
                    <input class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                </div>

                <div>
                  <label class="text-sm text-white/70 block">Endereço</label>
                  <input class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                  <div class="lg:col-span-1">
                    <label class="text-sm text-white/70 block">Cidade</label>
                    <input class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                  <div class="lg:col-span-1">
                    <label class="text-sm text-white/70 block">UF</label>
                    <input class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                  <div class="lg:col-span-1">
                    <label class="text-sm text-white/70 block">CEP</label>
                    <input class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                </div>

                <div>
                  <label class="text-sm text-white/70 block">Natureza da Operação</label>
                  <select class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                    <option>Venda de mercadoria</option>
                  </select>
                </div>

                <div class="pt-2">
                  <p class="text-xs font-semibold text-white/55 uppercase tracking-[0.18em]">Itens</p>

                  <div class="mt-4 glass-strong rounded-xl2 p-5">
                    <p class="text-sm text-white/70 mb-3">Item 1</p>
                    <input class="field w-full rounded-xl2 px-4 py-3 text-sm" placeholder="Descrição do item" />

                    <div class="mt-4 grid grid-cols-1 lg:grid-cols-4 gap-4 items-center">
                      <input class="field w-full rounded-xl2 px-4 py-3 text-sm" placeholder="NCM" />
                      <input class="field w-full rounded-xl2 px-4 py-3 text-sm" placeholder="CFOP" />
                      <input class="field w-full rounded-xl2 px-4 py-3 text-sm" placeholder="1" />
                      <input class="field w-full rounded-xl2 px-4 py-3 text-sm" placeholder="Preço" />
                    </div>

                    <div class="mt-2 flex items-center justify-end">
                      <span class="text-sm font-semibold text-emerald-500 whitespace-nowrap">R$ 0,00</span>
                    </div>

                    <div class="mt-4 flex items-center justify-center">
                      <button class="btn-ghost w-full sm:w-auto px-4 py-3 rounded-xl2 text-sm inline-flex items-center justify-center gap-2 opacity-60">
                        <span class="text-base leading-none">+</span>
                        <span>Adicionar Item</span>
                      </button>
                    </div>
                  </div>

                  <div class="mt-4 flex items-center justify-end">
                    <div class="text-right">
                      <p class="text-xs text-white/45">Total da Nota</p>
                      <p class="text-2xl font-semibold">R$ 0,00</p>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="text-sm text-white/70 block">Observações</label>
                  <textarea class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2 min-h-[110px]" placeholder="Informações adicionais..."></textarea>
                </div>

                <div class="flex items-center justify-end gap-3">
                  <button class="btn-ghost px-6 py-3 rounded-xl2 text-sm">Cancelar</button>
                  <button class="btn-primary px-6 py-3 rounded-xl2 text-sm font-semibold">Salvar Rascunho</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="view-usuarios" class="mt-6 space-y-6 hidden">
          <div class="glass rounded-xl2 border border-white/10 p-5 md:p-6">
            <div id="cfgPanelUsersList">
              <div class="mt-1 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <h3 class="text-lg font-semibold">Gestão de Usuários</h3>
                <button id="usersOpenCreate" class="btn-primary px-5 py-3 rounded-xl2 text-sm font-semibold w-full sm:w-auto whitespace-nowrap">Cadastrar Usuário</button>
              </div>
              <div id="usersStats" class="crm-stats crm-top-cards"></div>
              <div class="crm-segment-tabs" id="usersQuickTabs">
                <button type="button" data-user-filter="ALL" class="crm-tab-btn active">Todos</button>
                <button type="button" data-user-filter="STARTER" class="crm-tab-btn">Starter</button>
                <button type="button" data-user-filter="ESSENCIAL" class="crm-tab-btn">Essencial</button>
                <button type="button" data-user-filter="PROFISSIONAL" class="crm-tab-btn">Profissional</button>
                <button type="button" data-user-filter="EMPRESARIAL" class="crm-tab-btn">Empresarial</button>
                <button type="button" data-user-filter="ADMIN" class="crm-tab-btn">ADM</button>
              </div>
              <div class="crm-filter-panel">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                  <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/45">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        <path d="M10.8 18.2a7.4 7.4 0 1 1 0-14.8 7.4 7.4 0 0 1 0 14.8Z" stroke="currentColor" stroke-width="1.8" />
                      </svg>
                    </span>
                    <input id="usersSearch" class="field w-full rounded-xl2 px-12 py-3 text-sm" placeholder="Buscar por nome, CNPJ ou email..." />
                  </div>
                  <select id="usersPlanFilter" class="field rounded-xl2 px-4 py-3 text-sm">
                    <option value="ALL">Todos os planos</option>
                    <option value="STARTER">Starter</option>
                    <option value="ESSENCIAL">Essencial</option>
                    <option value="PROFISSIONAL">Profissional</option>
                    <option value="EMPRESARIAL">Empresarial</option>
                    <option value="ADMIN">ADM</option>
                  </select>
                  <select id="usersStatusFilter" class="field rounded-xl2 px-4 py-3 text-sm">
                    <option value="ALL">Todos status</option>
                    <option value="ACTIVE">Ativos</option>
                    <option value="INACTIVE">Inativos</option>
                  </select>
                </div>
                <div class="mt-3 flex items-center justify-end">
                  <button id="usersClearFilters" class="btn-ghost px-4 py-2 rounded-xl2 text-sm">Limpar filtros</button>
                </div>
              </div>
              <div class="mt-3 flex items-center justify-between gap-3">
                <div id="usersCount" class="text-sm text-white/70"></div>
                <div class="flex items-center gap-2">
                  <label for="usersPerPage" class="text-xs text-white/55 whitespace-nowrap">Por página</label>
                  <select id="usersPerPage" class="field rounded-xl2 px-3 py-1.5 text-xs w-[82px]">
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                  </select>
                </div>
              </div>
              <div id="usersMsg" class="mt-1 text-xs text-white/55"></div>
              <div id="usersCards" class="mt-3"></div>
              <div id="usersPagination" class="mt-4 hidden flex items-center justify-end gap-2">
                <button id="usersPrevPage" class="btn-ghost px-3 py-1.5 rounded-xl2 text-xs">Anterior</button>
                <span id="usersPageInfo" class="text-xs text-white/60 px-1"></span>
                <button id="usersNextPage" class="btn-ghost px-3 py-1.5 rounded-xl2 text-xs">Próxima</button>
              </div>
            </div>
          </div>
        </section>

        <div id="usersFormModal" class="hidden fixed inset-0 z-[85] items-center justify-center p-4">
          <div class="modal-backdrop absolute inset-0"></div>
          <div class="relative w-full max-w-[980px] glass-strong rounded-xl2 p-6">
            <div class="flex items-center justify-between gap-4">
              <h3 id="usersFormTitle" class="text-2xl font-semibold">Cadastrar Novo Usuário</h3>
              <button id="usersFormClose" class="btn-ghost px-4 py-2 rounded-xl2 text-sm">Fechar</button>
            </div>

            <div class="mt-5 space-y-6">
              <div class="space-y-3">
                <p class="text-sm font-semibold uppercase tracking-[0.08em] text-white/75">Dados da Empresa</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="md:col-span-2">
                    <label class="text-sm text-white/70">Razão social</label>
                    <input id="newUserCompany" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                  <div>
                    <label class="text-sm text-white/70">Nome</label>
                    <input id="newUserName" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                  <div>
                    <label class="text-sm text-white/70">CNPJ</label>
                    <input id="newUserCnpj" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                  <div>
                    <label class="text-sm text-white/70">Responsável</label>
                    <input id="newUserResponsible" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="Nome do responsável" />
                  </div>
                  <div>
                    <label class="text-sm text-white/70">Data da contratação</label>
                    <input id="newUserSignedAt" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" readonly />
                  </div>
                </div>
              </div>

              <div class="space-y-3">
                <p class="text-sm font-semibold uppercase tracking-[0.08em] text-white/75">Contato</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-white/70">E-mail</label>
                    <input id="newUserEmail" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                  </div>
                  <div>
                    <label class="text-sm text-white/70">WhatsApp (DDD + número)</label>
                    <input id="newUserWhatsapp" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" placeholder="11999998888" />
                  </div>
                </div>
              </div>

              <div class="space-y-3">
                <p class="text-sm font-semibold uppercase tracking-[0.08em] text-white/75">Plano e Acesso</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-white/70">Plano</label>
                    <select id="newUserPlan" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                      <option value="STARTER">Starter</option>
                      <option value="ESSENCIAL">Essencial</option>
                      <option value="PROFISSIONAL">Profissional</option>
                      <option value="EMPRESARIAL">Empresarial</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm text-white/70">Status / Cargo</label>
                    <select id="newUserRole" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2">
                      <option value="USER">Usuário</option>
                      <option value="ADMIN">ADM</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm text-white/70">Valor do plano</label>
                    <input id="newUserPlanValue" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" readonly />
                  </div>
                  <div>
                    <label class="text-sm text-white/70">Senha de acesso</label>
                    <div class="flex items-center gap-2 mt-2">
                      <div class="relative flex-1">
                        <input id="newUserPass" type="password" class="field w-full rounded-xl2 px-4 py-3 pr-14 text-sm" />
                        <button
                          id="newUserPassToggle"
                          type="button"
                          data-icon-toggle="1"
                          class="absolute right-2 top-1/2 -translate-y-1/2 btn-ghost px-2 py-1 rounded-lg text-xs"
                          aria-label="Mostrar senha"
                          title="Mostrar senha"
                        >
                          👁
                        </button>
                      </div>
                      <button id="newUserPassGenerate" type="button" class="btn-ghost px-4 py-3 rounded-xl2 text-sm whitespace-nowrap">Gerar</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-5 flex items-center justify-between gap-3">
              <span id="createUserMsg" class="text-sm text-white/60"></span>
              <div class="flex items-center gap-2">
                <button id="usersFormCancel" class="btn-ghost px-5 py-2 rounded-xl2 text-sm">Cancelar</button>
                <button id="createUserBtn" class="btn-primary px-5 py-2 rounded-xl2 text-sm">Salvar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- =========================
             ✅ VIEW: CAPTURA INDIVIDUAL (Base44)
             (ÃƒÂºnico ajuste do HTML: substitui o placeholder)
        ========================== -->
        <section id="view-captura-individual" class="mt-6 hidden">
          <div class="mx-auto w-full max-w-[980px]">
            <div class="glass rounded-xl2 border border-white/10 p-6 md:p-8">
              <div>
                <p class="text-[26px] leading-tight font-semibold text-white">Captura Individual</p>
                <p class="mt-2 text-[17px] text-white/70">Capturar notas fiscais de uma empresa</p>
              </div>

              <div class="mt-8">
                <p class="text-xs uppercase tracking-[0.14em] font-semibold text-white/80">Empresa</p>
                <select id="ciEmpresa" class="field mt-3 w-full rounded-xl2 px-4 py-3.5 text-sm">
                  <option value="">Selecione a empresa</option>
                </select>
              </div>

              <div class="mt-8">
                <p class="text-xs uppercase tracking-[0.14em] font-semibold text-white/80">Período (máx. 30 dias)</p>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-5">
                  <div>
                    <label class="text-sm font-medium text-white/80">Data Início</label>
                    <input id="ciDataInicio" type="date" class="field mt-2 w-full rounded-xl2 px-4 py-3 text-sm" />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-white/80">Data Fim</label>
                    <input id="ciDataFim" type="date" class="field mt-2 w-full rounded-xl2 px-4 py-3 text-sm" />
                  </div>
                </div>
              </div>

              <div class="mt-8">
                <p class="text-xs uppercase tracking-[0.14em] font-semibold text-white/80">Tipos de nota</p>
                <div class="mt-4 flex flex-wrap items-center gap-x-7 gap-y-3 text-base text-white/90">
                  <label class="inline-flex items-center gap-2.5">
                    <input id="ciTipoRecebidas" type="checkbox" checked class="h-[18px] w-[18px] accent-[rgb(109,94,247)]" />
                    Recebidas
                  </label>
                  <label class="inline-flex items-center gap-2.5">
                    <input id="ciTipoEmitidas" type="checkbox" checked class="h-[18px] w-[18px] accent-[rgb(109,94,247)]" />
                    Emitidas
                  </label>
                  <label class="inline-flex items-center gap-2.5">
                    <input id="ciTipoCanceladas" type="checkbox" checked class="h-[18px] w-[18px] accent-[rgb(109,94,247)]" />
                    Canceladas
                  </label>
                </div>
              </div>

              <div class="mt-8">
                <p class="text-xs uppercase tracking-[0.14em] font-semibold text-white/80">Formato</p>
                <select id="ciFormato" class="field mt-3 w-full rounded-xl2 px-4 py-3.5 text-sm">
                  <option>PDF + XML</option>
                  <option>Somente XML</option>
                  <option>Somente PDF</option>
                </select>
              </div>

              <div class="mt-8 border-t border-white/10 pt-6">
                <button
                  id="btnCapturarIndividual"
                  class="w-full btn-primary px-5 py-4 rounded-xl2 text-base font-semibold flex items-center justify-center gap-2.5 opacity-70"
                  disabled
                >
                  <span class="text-white/90">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                      <path d="M7 7h10v10H7V7Z" stroke="currentColor" stroke-width="1.6" />
                      <path d="M12 10v4m0 0 2-2m-2 2-2-2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </span>
                  <span id="labelCapturarIndividual">Iniciar Captura</span>
                </button>
              </div>
            </div>
          </div>
        </section>
      
        <div id="userConfigModal" class="hidden fixed inset-0 z-[70] items-center justify-center p-4">
          <div class="modal-backdrop absolute inset-0"></div>
          <div class="cfg-modal-shell relative w-full max-w-[980px] glass-strong rounded-xl2 p-5">
            <div class="flex items-center justify-between">
              <h3 class="text-2xl font-semibold">Configurações</h3>
              <button id="userConfigClose" class="btn-ghost px-4 py-2 rounded-xl2 text-sm">Fechar</button>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button id="cfgTabProfile" class="btn-ghost px-4 py-2 rounded-xl2 text-sm border border-[rgba(109,94,247,.55)] bg-[rgba(109,94,247,.18)]">Perfil da Conta</button>
              <button id="cfgTabTerms" class="btn-ghost px-4 py-2 rounded-xl2 text-sm">Termo de Uso</button>
              <button id="cfgTabPrivacy" class="btn-ghost px-4 py-2 rounded-xl2 text-sm">Política de Privacidade</button>
              <button id="cfgTabPlans" class="btn-ghost px-4 py-2 rounded-xl2 text-sm">Planos</button>
            </div>

            <div id="cfgPanelProfile" class="mt-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-white/70">Nome</label>
                  <input id="cfgName" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                </div>
                <div>
                  <label class="text-sm text-white/70">Email</label>
                  <input id="cfgEmail" class="field w-full rounded-xl2 px-4 py-3 text-sm mt-2" />
                </div>
                <div>
                  <label class="text-sm text-white/70">Nova senha</label>
                  <div class="relative mt-2">
                    <input id="cfgPass" type="password" class="field w-full rounded-xl2 px-4 py-3 pr-14 text-sm" />
                    <button
                      id="cfgPassToggle"
                      type="button"
                      data-icon-toggle="1"
                      class="absolute right-2 top-1/2 -translate-y-1/2 btn-ghost px-2 py-1 rounded-lg text-xs"
                      aria-label="Mostrar senha"
                      title="Mostrar senha"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.8"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <div>
                  <label class="text-sm text-white/70">Confirmar senha</label>
                  <div class="relative mt-2">
                    <input id="cfgPass2" type="password" class="field w-full rounded-xl2 px-4 py-3 pr-14 text-sm" />
                    <button
                      id="cfgPass2Toggle"
                      type="button"
                      data-icon-toggle="1"
                      class="absolute right-2 top-1/2 -translate-y-1/2 btn-ghost px-2 py-1 rounded-lg text-xs"
                      aria-label="Mostrar senha"
                      title="Mostrar senha"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.8"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              <div class="mt-5 flex items-center justify-between gap-3">
                <span id="cfgMsg" class="text-sm text-white/60"></span>
                <button id="userConfigSave" class="btn-primary px-5 py-2 rounded-xl2 text-sm">Salvar Perfil</button>
              </div>
            </div>

            <div id="cfgPanelTerms" class="mt-5 hidden">
              <div class="glass rounded-xl2 border border-white/10 p-6 md:p-7 max-h-[62vh] overflow-auto">
                <div class="space-y-6 text-[15px] leading-7 text-white/85">
                  <header class="space-y-1 border-b border-white/10 pb-5">
                    <h4 class="text-2xl md:text-3xl font-bold tracking-wide text-white">TERMO DE USO - FLUXONF</h4>
                    <p class="text-base md:text-lg font-semibold text-white/95">JVR SOLUÇÕES INTELIGENTES</p>
                    <p class="text-sm text-white/65">Última atualização: 2026</p>
                  </header>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">1. IDENTIFICAÇÃO</h5>
                    <p>Este Termo de Uso regula a utilização do sistema FluxoNF, software de automação fiscal desenvolvido e mantido por:</p>
                    <p class="font-semibold text-white">JVR SOLUÇÕES INTELIGENTES</p>
                    <p>Brasil</p>
                    <p>Ao contratar qualquer plano do FluxoNF, o usuário declara que leu, compreendeu e concorda integralmente com este Termo.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">2. OBJETO DO SERVIÇO</h5>
                    <p>O FluxoNF é uma plataforma online destinada à:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Captura automatizada de Notas Fiscais de Serviço (NFS-e)</li>
                      <li>Organização de documentos fiscais</li>
                      <li>Geração de arquivos para download</li>
                      <li>Armazenamento e rastreabilidade por empresa cadastrada</li>
                    </ul>
                    <p>O sistema não substitui contador, não realiza escrituração automática e não assume responsabilidade por obrigações fiscais do usuário.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">3. PLANOS DISPONÍVEIS</h5>
                    <p>O FluxoNF disponibiliza os seguintes planos:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Plano Starter</li>
                      <li>Plano Essencial</li>
                      <li>Plano Profissional</li>
                      <li>Plano Empresarial</li>
                    </ul>
                    <p>As especificações e limites de cada plano encontram-se descritos na página específica de Planos dentro do sistema.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">4. LIMITES E REGRAS DE USO</h5>
                    <p>4.1 O limite de utilização por CNPJ é técnico e contratual, conforme o plano contratado.</p>
                    <p>4.2 É proibido compartilhar login com terceiros não autorizados.</p>
                    <p>4.3 É proibido revender, sublicenciar ou redistribuir o acesso ao sistema.</p>
                    <p>4.4 É proibido utilizar o sistema para práticas ilícitas, fraudulentas ou que violem a legislação vigente.</p>
                    <p>4.5 É proibida qualquer tentativa de engenharia reversa, automação paralela, exploração de vulnerabilidades ou uso indevido da plataforma.</p>
                    <p>O descumprimento poderá resultar em suspensão ou cancelamento imediato do acesso, sem direito a reembolso.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">5. RESPONSABILIDADE DO USUÁRIO</h5>
                    <p>O usuário é integralmente responsável por:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Credenciais de acesso ao Portal Nacional</li>
                      <li>Certificados digitais utilizados</li>
                      <li>Obrigações fiscais e contábeis</li>
                      <li>Conferência das notas capturadas</li>
                      <li>Armazenamento legal conforme legislação vigente</li>
                    </ul>
                    <p>A JVR Soluções Inteligentes não se responsabiliza por falhas externas, indisponibilidades do Portal Nacional, instabilidades governamentais ou alterações nas regras públicas de acesso.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">6. PAGAMENTO E PROCESSAMENTO</h5>
                    <p>6.1 Os pagamentos são processados exclusivamente pela plataforma Hotmart.</p>
                    <p>6.2 A renovação é automática, conforme regras da Hotmart.</p>
                    <p>6.3 Em caso de inadimplência, o acesso poderá ser suspenso automaticamente.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">7. CANCELAMENTO E REEMBOLSO</h5>
                    <p>7.1 Não há fidelidade contratual. O cliente pode cancelar a qualquer momento.</p>
                    <p>7.2 O reembolso é garantido somente se solicitado dentro do prazo legal de 7 dias após a compra, conforme Código de Defesa do Consumidor.</p>
                    <p>7.3 Após o prazo de 7 dias corridos, contados da data de ativação do acesso, não haverá reembolso proporcional ou retroativo.</p>
                    <p>7.4 O cancelamento deve ser solicitado diretamente pela Área do Comprador Hotmart:</p>
                    <p><a href="https://consumer.hotmart.com" target="_blank" rel="noopener noreferrer" class="underline underline-offset-4">https://consumer.hotmart.com</a></p>
                    <p>7.5 Central de ajuda Hotmart:</p>
                    <p><a href="https://help.hotmart.com/pt-br" target="_blank" rel="noopener noreferrer" class="underline underline-offset-4">https://help.hotmart.com/pt-br</a></p>
                    <p>A JVR Soluções Inteligentes não realiza cancelamentos manuais fora da plataforma Hotmart.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">8. SUPORTE TÉCNICO</h5>
                    <p>O suporte é prestado nos seguintes dias e horários:</p>
                    <p>Segunda a sexta-feira, das 09h às 17h (horário de Brasília).</p>
                    <p>Não há atendimento em feriados nacionais.</p>
                    <p>O prazo de resposta poderá variar conforme o plano contratado.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">9. SUSPENSÃO OU ENCERRAMENTO</h5>
                    <p>O acesso poderá ser suspenso ou encerrado em caso de:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Inadimplência</li>
                      <li>Violação deste Termo</li>
                      <li>Uso indevido da plataforma</li>
                      <li>Tentativa de exploração técnica</li>
                    </ul>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">10. PROPRIEDADE INTELECTUAL</h5>
                    <p>O FluxoNF é propriedade exclusiva da JVR Soluções Inteligentes.</p>
                    <p>É proibido:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Copiar o código-fonte</li>
                      <li>Realizar engenharia reversa</li>
                      <li>Comercializar ou distribuir o sistema sem autorização</li>
                      <li>Reproduzir parcial ou integralmente a plataforma</li>
                    </ul>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">11. DISPONIBILIDADE DO SERVIÇO</h5>
                    <p>A JVR Soluções Inteligentes busca manter o sistema disponível continuamente.</p>
                    <p>Entretanto, poderão ocorrer interrupções por:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Manutenções</li>
                      <li>Atualizações</li>
                      <li>Instabilidades externas</li>
                      <li>Problemas no Portal Nacional</li>
                    </ul>
                    <p>Não há SLA contratual de uptime garantido.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">12. ALTERAÇÕES</h5>
                    <p>A JVR Soluções Inteligentes poderá atualizar este Termo a qualquer momento.</p>
                    <p>Clientes ativos permanecem com as condições vigentes no momento da contratação, desde que estejam adimplentes.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">13. FORO</h5>
                    <p>Fica eleito o foro da comarca do domicílio da empresa JVR Soluções Inteligentes para dirimir quaisquer controvérsias decorrentes deste Termo.</p>
                  </section>
                </div>
              </div>
            </div>

            <div id="cfgPanelPrivacy" class="mt-5 hidden">
              <div class="glass rounded-xl2 border border-white/10 p-6 md:p-7 max-h-[62vh] overflow-auto">
                <div class="space-y-6 text-[15px] leading-7 text-white/85">
                  <header class="space-y-1 border-b border-white/10 pb-5">
                    <h4 class="text-2xl md:text-3xl font-bold tracking-wide text-white">POLÍTICA DE PRIVACIDADE - FLUXONF</h4>
                    <p class="text-base md:text-lg font-semibold text-white/95">JVR SOLUÇÕES INTELIGENTES</p>
                    <p class="text-sm text-white/65">Última atualização: 2026</p>
                  </header>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">1. DADOS COLETADOS</h5>
                    <p>O FluxoNF pode coletar:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Nome</li>
                      <li>E-mail</li>
                      <li>Dados empresariais (CNPJ)</li>
                      <li>Informações necessárias para funcionamento do sistema</li>
                      <li>Logs de acesso</li>
                    </ul>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">2. FINALIDADE DO USO DOS DADOS</h5>
                    <p>Os dados são utilizados exclusivamente para:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Funcionamento da plataforma</li>
                      <li>Autenticação</li>
                      <li>Processamento das capturas</li>
                      <li>Comunicação com o cliente</li>
                      <li>Suporte técnico</li>
                    </ul>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">3. COMPARTILHAMENTO</h5>
                    <p>A JVR Soluções Inteligentes não vende ou compartilha dados com terceiros, exceto quando necessário para:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Processamento de pagamento (Hotmart)</li>
                      <li>Cumprimento de obrigações legais</li>
                    </ul>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">4. SEGURANÇA</h5>
                    <p>Adotamos boas práticas de segurança e armazenamento para proteção das informações.</p>
                    <p>Entretanto, nenhum sistema é 100% imune a falhas externas.</p>
                  </section>

                  <section class="space-y-3">
                    <h5 class="text-lg md:text-xl font-bold text-white">5. DIREITOS DO TITULAR</h5>
                    <p>O usuário pode solicitar:</p>
                    <ul class="list-disc pl-5 space-y-1">
                      <li>Acesso aos seus dados</li>
                      <li>Correção de dados incorretos</li>
                      <li>Exclusão de conta (quando aplicável)</li>
                    </ul>
                    <p>Solicitações devem ser feitas via canal oficial de suporte.</p>
                  </section>
                </div>
              </div>
            </div>

            <div id="cfgPanelPlans" class="mt-5 hidden space-y-4">
              <div id="cfgCurrentPlanCard" class="glass rounded-xl2 border border-white/10 p-5"></div>
              <div id="cfgUpgradePlans" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
              <div class="glass rounded-xl2 border border-white/10 p-4 text-xs text-white/65 space-y-1">
                <p>Não há fidelidade contratual. Cancelamento pode ser feito a qualquer momento.</p>
                <p>Reembolso disponível somente dentro de 7 dias após a compra.</p>
                <p>Pagamento processado via Hotmart. Cancelamento pela Área do Comprador: https://consumer.hotmart.com</p>
                <p>Suporte técnico: segunda a sexta, 09h às 17h (exceto feriados nacionais).</p>
              </div>
            </div>

          </div>
        </div>
      </main>
    </div>

    <!-- =========================
         JS: Navegação + modal + tema + empresas + captura em lote + ✅ captura individual
         ✅ Ajustes pedidos:
         - inclui a parte da captura individual (layout Base44 + lÃƒÂ³gica mÃƒÂ­nima)
         - nÃƒÂ£o altera o resto
    ========================== -->
    <script>
      // --------- ProteÃƒÂ§ÃƒÂ£o bÃƒÂ¡sica (se nÃƒÂ£o tiver login salvo, volta pro index) ----------
      const rawUser = localStorage.getItem("nfseUser");
      if (!rawUser) {
        window.location.href = "/index.html";
      }

      // --------- UsuÃƒÂ¡rio (mesmo esquema que vocÃƒÂª usa) ----------
      let currentUser = {};
      try {
        const parsed = rawUser ? JSON.parse(rawUser) : null;
        currentUser = parsed && typeof parsed === "object" ? parsed : { email: rawUser || "" };
      } catch (e) {
        currentUser = { email: rawUser || "" };
      }

      const nameToShow =
        currentUser.displayName ||
        currentUser.name ||
        (currentUser.email ? currentUser.email.split("@")[0] : "Usuário");

      const userNameDisplay = document.getElementById("userNameDisplay");
      const userAvatar = document.getElementById("userAvatar");
      if (userNameDisplay) userNameDisplay.textContent = nameToShow || "...";
      if (userAvatar) userAvatar.textContent = (nameToShow || "?").slice(0, 1).toUpperCase();

      const userMenuBtn = document.getElementById("userMenuBtn");
      const userMenuDropdown = document.getElementById("userMenuDropdown");
      const userConfigBtn = document.getElementById("userConfigBtn");
      const clientPlanBadge = document.getElementById("clientPlanBadge");
      const adminMenuBlock = document.getElementById("adminMenuBlock");
      const userConfigModal = document.getElementById("userConfigModal");
      const userConfigClose = document.getElementById("userConfigClose");
      const userConfigSave = document.getElementById("userConfigSave");
      const cfgName = document.getElementById("cfgName");
      const cfgEmail = document.getElementById("cfgEmail");
      const cfgPass = document.getElementById("cfgPass");
      const cfgPass2 = document.getElementById("cfgPass2");
      const cfgPassToggle = document.getElementById("cfgPassToggle");
      const cfgPass2Toggle = document.getElementById("cfgPass2Toggle");
      const cfgMsg = document.getElementById("cfgMsg");

      const cfgTabProfile = document.getElementById("cfgTabProfile");
      const cfgTabTerms = document.getElementById("cfgTabTerms");
      const cfgTabPrivacy = document.getElementById("cfgTabPrivacy");
      const cfgTabPlans = document.getElementById("cfgTabPlans");
      const cfgPanelProfile = document.getElementById("cfgPanelProfile");
      const cfgPanelTerms = document.getElementById("cfgPanelTerms");
      const cfgPanelPrivacy = document.getElementById("cfgPanelPrivacy");
      const cfgPanelPlans = document.getElementById("cfgPanelPlans");
      const cfgCurrentPlanCard = document.getElementById("cfgCurrentPlanCard");
      const cfgUpgradePlans = document.getElementById("cfgUpgradePlans");

      const createUserBtn = document.getElementById("createUserBtn");
      const createUserMsg = document.getElementById("createUserMsg");
      const newUserName = document.getElementById("newUserName");
      const newUserCompany = document.getElementById("newUserCompany");
      const newUserCnpj = document.getElementById("newUserCnpj");
      const newUserWhatsapp = document.getElementById("newUserWhatsapp");
      const newUserPlan = document.getElementById("newUserPlan");
      const newUserPlanValue = document.getElementById("newUserPlanValue");
      const newUserSignedAt = document.getElementById("newUserSignedAt");
      const newUserEmail = document.getElementById("newUserEmail");
      const newUserPass = document.getElementById("newUserPass");
      const newUserPassToggle = document.getElementById("newUserPassToggle");
      const newUserPassGenerate = document.getElementById("newUserPassGenerate");
      const newUserResponsible = document.getElementById("newUserResponsible");
      const newUserRole = document.getElementById("newUserRole");
      const usersSearch = document.getElementById("usersSearch");
      const usersPlanFilter = document.getElementById("usersPlanFilter");
      const usersStatusFilter = document.getElementById("usersStatusFilter");
      const usersClearFilters = document.getElementById("usersClearFilters");
      const usersQuickTabs = document.getElementById("usersQuickTabs");
      const usersCards = document.getElementById("usersCards");
      const usersCount = document.getElementById("usersCount");
      const usersStats = document.getElementById("usersStats");
      const usersMsg = document.getElementById("usersMsg");
      const usersPerPage = document.getElementById("usersPerPage");
      const usersPagination = document.getElementById("usersPagination");
      const usersPrevPage = document.getElementById("usersPrevPage");
      const usersNextPage = document.getElementById("usersNextPage");
      const usersPageInfo = document.getElementById("usersPageInfo");
      const usersOpenCreate = document.getElementById("usersOpenCreate");
      const usersFormModal = document.getElementById("usersFormModal");
      const usersFormTitle = document.getElementById("usersFormTitle");
      const usersFormClose = document.getElementById("usersFormClose");
      const usersFormCancel = document.getElementById("usersFormCancel");

      let adminUsersCache = [];
      let usersFormMode = "create";
      let usersEditId = null;
      let usersCurrentPage = 1;
      let usersPerPageSize = 10;
      let usersActiveFilter = "ALL";
      let usersStatusActiveFilter = "ALL";
      const userPasswordVault = (() => {
        try {
          const raw = localStorage.getItem("nfseUserPasswordVault");
          const parsed = raw ? JSON.parse(raw) : {};
          return parsed && typeof parsed === "object" ? parsed : {};
        } catch (e) {
          return {};
        }
      })();
      const PLAN_VALUES = {
        STARTER: 49.9,
        ESSENCIAL: 49.9,
        PROFISSIONAL: 97.0,
        EMPRESARIAL: 147.0,
      };
      const PLAN_ORDER = ["ESSENCIAL", "PROFISSIONAL", "EMPRESARIAL"];
      const PLAN_META = {
        STARTER: {
          label: "Plano Starter",
          desc: "CNPJs ilimitados, captura automatizada ilimitada, histórico completo, ZIP, atualizações futuras e acesso antecipado. Disponível para os 10 primeiros clientes.",
          support: "Suporte prioritário",
        },
        ESSENCIAL: {
          label: "Plano Essencial",
          desc: "Até 30 CNPJs cadastrados, captura ilimitada, organização e histórico completo, ZIP e atualizações inclusas.",
          support: "Suporte padrão",
        },
        PROFISSIONAL: {
          label: "Plano Profissional",
          desc: "Até 100 CNPJs cadastrados, captura ilimitada, rastreabilidade completa, ZIP e acesso antecipado a novos módulos.",
          support: "Suporte prioritário",
        },
        EMPRESARIAL: {
          label: "Plano Empresarial",
          desc: "Até 300 CNPJs cadastrados, captura ilimitada, organização avançada, ZIP e processamento prioritário.",
          support: "Suporte prioritário",
        },
      };

      function formatMoneyBRL(v) {
        const n = Number(v || 0);
        return `R$ ${n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      function maskPhoneDigits(v) {
        const d = String(v || "").replace(/\D/g, "").slice(0, 11);
        if (d.length <= 2) return d;
        if (d.length <= 6) return `(${d.slice(0, 2)}) ${d.slice(2)}`;
        if (d.length <= 10) return `(${d.slice(0, 2)}) ${d.slice(2, 6)}-${d.slice(6)}`;
        return `(${d.slice(0, 2)}) ${d.slice(2, 7)}-${d.slice(7)}`;
      }

      function savePasswordVault() {
        try { localStorage.setItem("nfseUserPasswordVault", JSON.stringify(userPasswordVault)); } catch (e) {}
      }

      function setPasswordVault(email, password) {
        const key = String(email || "").trim().toLowerCase();
        if (!key || !password) return;
        userPasswordVault[key] = String(password);
        savePasswordVault();
      }

      function getPasswordVault(email) {
        const key = String(email || "").trim().toLowerCase();
        return key ? String(userPasswordVault[key] || "") : "";
      }

      function isAdminUser() {
        return String(currentUser?.role || "").toUpperCase() === "ADMIN";
      }

      function normalizePlanCode(plan) {
        const p = String(plan || "").trim().toUpperCase();
        if (p === "LANCAMENTO") return "STARTER";
        if (p === "STARTER") return "STARTER";
        if (p === "PRO") return "EMPRESARIAL";
        if (p === "FUNDADORES") return "STARTER";
        if (PLAN_META[p]) return p;
        return "ESSENCIAL";
      }

      function getPlanLabel(plan) {
        const code = normalizePlanCode(plan);
        return PLAN_META[code]?.label || "Plano Essencial";
      }

      function renderUsersStats(allUsers = []) {
        if (!usersStats) return;
        const countBy = (fn) => allUsers.filter(fn).length;
        const total = allUsers.length;
        const admins = countBy((u) => String(u?.role || "").toUpperCase() === "ADMIN");
        const starter = countBy((u) => normalizePlanCode(u?.plan) === "STARTER");
        const ess = countBy((u) => normalizePlanCode(u?.plan) === "ESSENCIAL");
        const prof = countBy((u) => normalizePlanCode(u?.plan) === "PROFISSIONAL");
        const emp = countBy((u) => normalizePlanCode(u?.plan) === "EMPRESARIAL");

        const chips = [
          { key: "ALL", label: "Total clientes", value: total },
          { key: "ADMIN", label: "ADM", value: admins },
          { key: "STARTER", label: "Starter", value: starter },
          { key: "ESSENCIAL", label: "Essencial", value: ess },
          { key: "PROFISSIONAL", label: "Profissional", value: prof },
          { key: "EMPRESARIAL", label: "Empresarial", value: emp },
        ];

        usersStats.innerHTML = chips
          .map((x) => `
            <button type="button" class="crm-stat-chip ${usersActiveFilter === x.key ? "active" : ""}" data-user-filter="${x.key}">
              <span class="crm-stat-label">${x.label}</span>
              <span class="crm-stat-value">${x.value}</span>
            </button>
          `)
          .join("");
      }

      function syncUserFilterUi() {
        if (usersPlanFilter) usersPlanFilter.value = usersActiveFilter;
        if (usersQuickTabs) {
          const tabs = usersQuickTabs.querySelectorAll("[data-user-filter]");
          tabs.forEach((t) => t.classList.toggle("active", String(t.getAttribute("data-user-filter") || "") === usersActiveFilter));
        }
        if (usersStatusFilter) usersStatusFilter.value = usersStatusActiveFilter;
      }

      function renderClientPlanBadge() {
        if (!clientPlanBadge) return;
        // Regra: plano nao aparece na tela principal do dashboard.
        clientPlanBadge.classList.add("hidden");
        clientPlanBadge.textContent = "";
      }

      function esc(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      if (cfgName) cfgName.value = currentUser.displayName || currentUser.name || "";
      if (cfgEmail) cfgEmail.value = currentUser.email || "";
      if (adminMenuBlock && !isAdminUser()) adminMenuBlock.classList.add("hidden");
      renderClientPlanBadge();

      async function renderPlanPanel() {
        if (!cfgCurrentPlanCard || !cfgUpgradePlans) return;
        await syncCurrentUserFromServer();

        if (isAdminUser()) {
          const all = ["STARTER", "ESSENCIAL", "PROFISSIONAL", "EMPRESARIAL"];
          cfgCurrentPlanCard.innerHTML = `
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <p class="text-xs uppercase tracking-[0.15em] text-white/55">Modo Administrador</p>
                <p class="text-xl font-semibold mt-1">Todos os planos disponíveis</p>
                <p class="text-sm text-white/75 mt-2">Perfil de admin não possui plano vinculado. Esta visão é apenas gerencial.</p>
              </div>
            </div>
          `;

          cfgUpgradePlans.innerHTML = all
            .map((code) => {
              const meta = PLAN_META[code];
              const price = formatMoneyBRL(PLAN_VALUES[code] || 0);
              return `
                <article class="glass rounded-xl2 border border-white/10 p-4">
                  <p class="text-base font-semibold">${meta.label}</p>
                  <p class="text-sm text-white/75 mt-2">${meta.desc}</p>
                  <div class="mt-3">
                    <span class="text-sm font-semibold text-emerald-300">${price} / mês</span>
                  </div>
                </article>
              `;
            })
            .join("");
          return;
        }

        const planCode = normalizePlanCode(currentUser?.plan);
        const planMeta = PLAN_META[planCode] || PLAN_META.ESSENCIAL;
        const planValue = Number(currentUser?.plan_value || PLAN_VALUES[planCode] || PLAN_VALUES.ESSENCIAL);

        cfgCurrentPlanCard.innerHTML = `
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-[0.15em] text-white/55">Meu Plano</p>
              <p class="text-xl font-semibold mt-1">${planMeta.label}</p>
              <p class="text-sm text-white/75 mt-2">${planMeta.desc}</p>
              <p class="text-xs text-white/55 mt-2">${planMeta.support}</p>
            </div>
            <div class="px-3 py-2 rounded-xl2 bg-emerald-500/12 border border-emerald-500/35 text-emerald-200 text-sm font-semibold">
              ${formatMoneyBRL(planValue)} / mês
            </div>
          </div>
        `;

        if (planCode === "STARTER") {
          cfgUpgradePlans.innerHTML = `
            <div class="glass rounded-xl2 border border-white/10 p-4 text-sm text-white/75 md:col-span-2">
              Para este plano não há upgrade automático exibido nesta área.
            </div>
          `;
          return;
        }

        const currentIdx = PLAN_ORDER.indexOf(planCode);
        const upgrades = PLAN_ORDER.filter((_, idx) => idx > currentIdx);
        if (!upgrades.length) {
          cfgUpgradePlans.innerHTML = `
            <div class="glass rounded-xl2 border border-white/10 p-4 text-sm text-white/75 md:col-span-2">
              Você já está no maior plano disponível no momento.
            </div>
          `;
          return;
        }

        cfgUpgradePlans.innerHTML = upgrades
          .map((code) => {
            const meta = PLAN_META[code];
            const price = formatMoneyBRL(PLAN_VALUES[code] || 0);
            return `
              <article class="glass rounded-xl2 border border-white/10 p-4">
                <p class="text-base font-semibold">${meta.label}</p>
                <p class="text-sm text-white/75 mt-2">${meta.desc}</p>
                <div class="mt-3 flex items-center justify-between gap-2">
                  <span class="text-sm font-semibold text-emerald-300">${price} / mês</span>
                  <button type="button" class="btn-primary px-3 py-1.5 rounded-xl2 text-xs" data-plan-upgrade="${code}">Solicitar Upgrade</button>
                </div>
              </article>
            `;
          })
          .join("");
      }

      async function setCfgTab(tab) {
        const tabs = [cfgTabProfile, cfgTabTerms, cfgTabPrivacy, cfgTabPlans].filter(Boolean);
        tabs.forEach((b) => {
          b.classList.remove("border", "border-[rgba(109,94,247,.55)]", "bg-[rgba(109,94,247,.18)]");
        });
        const active =
          tab === "terms" ? cfgTabTerms :
          tab === "privacy" ? cfgTabPrivacy :
          tab === "plans" ? cfgTabPlans :
          cfgTabProfile;
        if (active) active.classList.add("border", "border-[rgba(109,94,247,.55)]", "bg-[rgba(109,94,247,.18)]");

        if (cfgPanelProfile) cfgPanelProfile.classList.toggle("hidden", tab !== "profile");
        if (cfgPanelTerms) cfgPanelTerms.classList.toggle("hidden", tab !== "terms");
        if (cfgPanelPrivacy) cfgPanelPrivacy.classList.toggle("hidden", tab !== "privacy");
        if (cfgPanelPlans) cfgPanelPlans.classList.toggle("hidden", tab !== "plans");
        if (tab === "plans") await renderPlanPanel();
      }

      function renderAdminUsers() {
        if (!usersCards) return;
        const q = (usersSearch?.value || "").trim().toLowerCase();
        const list = adminUsersCache.filter((u) => {
          const role = String(u?.role || "").toUpperCase();
          const planCode = normalizePlanCode(u?.plan);

          if (usersActiveFilter === "ADMIN" && role !== "ADMIN") return false;
          if (["STARTER", "ESSENCIAL", "PROFISSIONAL", "EMPRESARIAL"].includes(usersActiveFilter) && planCode !== usersActiveFilter) return false;
          if (usersStatusActiveFilter === "ACTIVE" && !u?.is_active) return false;
          if (usersStatusActiveFilter === "INACTIVE" && !!u?.is_active) return false;

          if (!q) return true;
          const hay = `${u.name || ""} ${u.email || ""} ${u.cnpj || ""} ${u.company_name || ""}`.toLowerCase();
          return hay.includes(q);
        }).sort((a, b) => {
          const an = String(a?.name || "").toLocaleLowerCase("pt-BR");
          const bn = String(b?.name || "").toLocaleLowerCase("pt-BR");
          const byName = an.localeCompare(bn, "pt-BR");
          if (byName !== 0) return byName;
          return String(a?.email || "").toLocaleLowerCase("pt-BR").localeCompare(String(b?.email || "").toLocaleLowerCase("pt-BR"), "pt-BR");
        });

        const total = list.length;
        renderUsersStats(adminUsersCache);
        const totalPages = Math.max(1, Math.ceil(total / usersPerPageSize));
        if (usersCurrentPage > totalPages) usersCurrentPage = totalPages;
        const start = (usersCurrentPage - 1) * usersPerPageSize;
        const end = start + usersPerPageSize;
        const pageItems = list.slice(start, end);
        syncUserFilterUi();

        if (usersCount) {
          const from = total ? start + 1 : 0;
          const to = Math.min(end, total);
          usersCount.textContent = `${total} cliente(s) encontrado(s) • Mostrando ${from}-${to}`;
        }
        if (usersPageInfo) usersPageInfo.textContent = `Página ${usersCurrentPage} de ${totalPages}`;
        if (usersPagination) usersPagination.classList.toggle("hidden", total <= usersPerPageSize);
        if (usersPrevPage) usersPrevPage.disabled = usersCurrentPage <= 1;
        if (usersNextPage) usersNextPage.disabled = usersCurrentPage >= totalPages;

        if (!pageItems.length) {
          usersCards.innerHTML = `<div class="glass-strong rounded-xl2 p-4 text-sm text-white/60">Nenhum usuário encontrado.</div>`;
          return;
        }

        usersCards.innerHTML = `
          <div class="crm-users-table-wrap">
            <table class="crm-users-table">
              <thead>
                <tr>
                  <th>Empresa</th>
                  <th>CNPJ</th>
                  <th>Contato</th>
                  <th>Plano</th>
                  <th>Senha</th>
                  <th>Status</th>
                  <th class="text-right">Ações</th>
                </tr>
              </thead>
              <tbody>
                ${pageItems
                  .map((u) => {
                    const planCode = normalizePlanCode(u?.plan);
                    const planLabel = getPlanLabel(planCode).replace("Plano ", "");
                    const statusLabel = u.is_active ? "Ativo" : "Desativado";
                    const statusClass = u.is_active
                      ? "bg-emerald-500/15 border border-emerald-500/35 text-emerald-300"
                      : "bg-rose-500/12 border border-rose-500/35 text-rose-300";
                    const vaultPass = getPasswordVault(u?.email);
                    const plainServerPass = String(u?.password_plain || "");
                    const passRaw = plainServerPass || vaultPass;
                    const passView = passRaw ? esc(passRaw) : "Sem senha salva";
                    return `
                      <tr data-user-open="${u.id}">
                        <td>
                          <button type="button" class="text-sm font-semibold text-left hover:underline" data-user-open-btn="${u.id}">${esc(u.name || "-")}</button>
                          <p class="text-xs text-white/55 mt-0.5">${esc(u.company_name || "-")}</p>
                        </td>
                        <td class="text-sm">${esc(u.cnpj || "-")}</td>
                        <td>
                          <p class="text-sm">${esc(u.email || "-")}</p>
                          <p class="text-xs text-white/55 mt-0.5">${esc(u.whatsapp || "-")}</p>
                        </td>
                        <td><span class="crm-plan-pill">${esc(planLabel)}</span></td>
                        <td>
                          <span class="crm-pass-cell">
                            <span data-pass-state="masked">${passRaw ? "••••••••" : "Sem senha salva"}</span>
                            <span data-pass-state="plain" class="hidden">${passView}</span>
                            <button type="button" class="crm-pass-eye" data-pass-toggle="1" title="Visualizar senha" aria-label="Visualizar senha">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.8"/>
                              </svg>
                            </button>
                          </span>
                        </td>
                        <td>
                          <span class="px-2.5 py-1 rounded-full text-[11px] font-semibold whitespace-nowrap ${statusClass}">${statusLabel}</span>
                        </td>
                        <td class="text-right">
                          <div class="crm-action-menu inline-block">
                            <button type="button" class="btn-ghost px-2.5 py-1.5 rounded-xl2 text-sm" data-user-menu-toggle="${u.id}">•••</button>
                            <div class="crm-action-menu-list hidden" data-user-menu="${u.id}">
                              <button data-user-action="edit" data-id="${u.id}">Editar</button>
                              <button data-user-action="reset" data-id="${u.id}">Alterar senha</button>
                              <button data-user-action="toggle" data-id="${u.id}">${u.is_active ? "Desativar" : "Ativar"}</button>
                              <button data-user-action="delete" data-id="${u.id}" class="text-red-300">Excluir</button>
                            </div>
                          </div>
                        </td>
                      </tr>
                    `;
                  })
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      }

      function openUsersForm(mode, user) {
        usersFormMode = mode === "edit" ? "edit" : "create";
        usersEditId = usersFormMode === "edit" ? String(user?.id || "") : null;
        if (usersFormTitle) usersFormTitle.textContent = usersFormMode === "edit" ? "Editar Usuário" : "Cadastrar Novo Usuário";
        if (createUserBtn) createUserBtn.textContent = usersFormMode === "edit" ? "Salvar Alterações" : "Salvar";
        if (createUserMsg) createUserMsg.textContent = "";

        if (newUserName) newUserName.value = usersFormMode === "edit" ? (user?.name || "") : "";
        if (newUserEmail) newUserEmail.value = usersFormMode === "edit" ? (user?.email || "") : "";
        if (newUserCompany) newUserCompany.value = usersFormMode === "edit" ? (user?.company_name || "") : "";
        if (newUserCnpj) newUserCnpj.value = usersFormMode === "edit" ? (user?.cnpj || "") : "";
        if (newUserResponsible) newUserResponsible.value = usersFormMode === "edit" ? (user?.name || "") : "";
        if (newUserWhatsapp) newUserWhatsapp.value = usersFormMode === "edit" ? maskPhoneDigits(user?.whatsapp || "") : "";
        if (newUserPlan) newUserPlan.value = usersFormMode === "edit" ? normalizePlanCode(user?.plan) : "ESSENCIAL";
        const planCode = normalizePlanCode(usersFormMode === "edit" ? user?.plan : "ESSENCIAL");
        if (newUserPlanValue) newUserPlanValue.value = formatMoneyBRL(user?.plan_value || PLAN_VALUES[planCode] || PLAN_VALUES.ESSENCIAL);
        if (newUserSignedAt) {
          const dt = usersFormMode === "edit" ? (user?.created_at || "") : new Date().toISOString();
          newUserSignedAt.value = dt ? String(dt).slice(0, 10).split("-").reverse().join("/") : "-";
        }
        if (newUserPass) {
          newUserPass.type = "password";
          const serverPass = String(user?.password_plain || "");
          const knownPass = usersFormMode === "edit" ? (serverPass || getPasswordVault(user?.email)) : "";
          newUserPass.value = knownPass;
        }
        if (newUserRole) newUserRole.value = usersFormMode === "edit" ? (((user?.role || "USER").toUpperCase() === "ADMIN") ? "ADMIN" : "USER") : "USER";

        if (usersFormModal) {
          usersFormModal.classList.remove("hidden");
          usersFormModal.classList.add("flex");
        }
      }

      function closeUsersForm() {
        if (!usersFormModal) return;
        usersFormModal.classList.add("hidden");
        usersFormModal.classList.remove("flex");
      }

      async function loadAdminUsers() {
        if (!usersCards) return;
        if (!isAdminUser()) {
          adminUsersCache = [];
          if (usersCards) usersCards.innerHTML = "";
          if (usersStats) usersStats.innerHTML = "";
          if (usersPagination) usersPagination.classList.add("hidden");
          if (usersCount) usersCount.textContent = "";
          if (usersMsg) usersMsg.textContent = "Acesso restrito para administradores.";
          return;
        }
        if (usersMsg) usersMsg.textContent = "Carregando usuários...";
        try {
          const res = await fetch("/admin/users", { credentials: "include", cache: "no-store" });
          if (!res.ok) {
            if (usersMsg) usersMsg.textContent = "Sem permissão ou erro ao listar usuários.";
            adminUsersCache = [];
            renderAdminUsers();
            return;
          }
          const data = await res.json().catch(() => ({}));
          adminUsersCache = Array.isArray(data?.users) ? data.users : [];
          adminUsersCache.forEach((u) => {
            if (u?.email && u?.password_plain) setPasswordVault(u.email, u.password_plain);
          });
          usersCurrentPage = 1;
          if (usersMsg) usersMsg.textContent = "";
          renderAdminUsers();
        } catch (e) {
          if (usersMsg) usersMsg.textContent = "Erro ao carregar usuários.";
        }
      }

      if (usersSearch) {
        usersSearch.addEventListener("input", () => {
          usersCurrentPage = 1;
          renderAdminUsers();
        });
      }
      if (usersStats && !usersStats.dataset.bound) {
        usersStats.dataset.bound = "1";
        usersStats.addEventListener("click", (ev) => {
          const btn = ev.target.closest("[data-user-filter]");
          if (!btn) return;
          usersActiveFilter = String(btn.getAttribute("data-user-filter") || "ALL");
          usersCurrentPage = 1;
          renderAdminUsers();
        });
      }
      if (usersQuickTabs && !usersQuickTabs.dataset.bound) {
        usersQuickTabs.dataset.bound = "1";
        usersQuickTabs.addEventListener("click", (ev) => {
          const btn = ev.target.closest("[data-user-filter]");
          if (!btn) return;
          usersActiveFilter = String(btn.getAttribute("data-user-filter") || "ALL");
          usersCurrentPage = 1;
          renderAdminUsers();
        });
      }
      if (usersPlanFilter) {
        usersPlanFilter.addEventListener("change", () => {
          usersActiveFilter = String(usersPlanFilter.value || "ALL");
          usersCurrentPage = 1;
          renderAdminUsers();
        });
      }
      if (usersStatusFilter) {
        usersStatusFilter.addEventListener("change", () => {
          usersStatusActiveFilter = String(usersStatusFilter.value || "ALL");
          usersCurrentPage = 1;
          renderAdminUsers();
        });
      }
      if (usersClearFilters) {
        usersClearFilters.addEventListener("click", () => {
          usersActiveFilter = "ALL";
          usersStatusActiveFilter = "ALL";
          if (usersSearch) usersSearch.value = "";
          usersCurrentPage = 1;
          renderAdminUsers();
        });
      }
      if (usersPerPage) {
        usersPerPage.addEventListener("change", () => {
          usersPerPageSize = Math.max(1, Number(usersPerPage.value) || 10);
          usersCurrentPage = 1;
          renderAdminUsers();
        });
      }
      if (usersPrevPage) {
        usersPrevPage.addEventListener("click", () => {
          if (usersCurrentPage <= 1) return;
          usersCurrentPage -= 1;
          renderAdminUsers();
        });
      }
      if (usersNextPage) {
        usersNextPage.addEventListener("click", () => {
          usersCurrentPage += 1;
          renderAdminUsers();
        });
      }

      if (usersCards && !usersCards.dataset.bound) {
        usersCards.dataset.bound = "1";
        usersCards.addEventListener("click", async (ev) => {
          if (!isAdminUser()) return;
          const passToggle = ev.target.closest("[data-pass-toggle]");
          if (passToggle) {
            const cell = passToggle.closest(".crm-pass-cell");
            if (!cell) return;
            const masked = cell.querySelector('[data-pass-state="masked"]');
            const plain = cell.querySelector('[data-pass-state="plain"]');
            if (!masked || !plain) return;
            const show = plain.classList.contains("hidden");
            plain.classList.toggle("hidden", !show);
            masked.classList.toggle("hidden", show);
            return;
          }

          const menuToggle = ev.target.closest("[data-user-menu-toggle]");
          if (menuToggle) {
            const id = menuToggle.getAttribute("data-user-menu-toggle");
            const allMenus = usersCards.querySelectorAll("[data-user-menu]");
            allMenus.forEach((m) => {
              const same = String(m.getAttribute("data-user-menu") || "") === String(id || "");
              if (!same) {
                m.classList.add("hidden");
              } else {
                m.classList.toggle("hidden");
              }
            });
            return;
          }

          const btn = ev.target.closest("button[data-user-action][data-id]");
          if (!btn) {
            const openBtn = ev.target.closest("[data-user-open-btn]");
            if (openBtn) {
              const id = openBtn.getAttribute("data-user-open-btn");
              const target = adminUsersCache.find((u) => String(u.id) === String(id));
              if (!target) return;
              openUsersForm("edit", target);
              return;
            }
            const card = ev.target.closest("[data-user-open]");
            if (!card) return;
            if (ev.target.closest(".crm-action-menu")) return;
            const id = card.getAttribute("data-user-open");
            const target = adminUsersCache.find((u) => String(u.id) === String(id));
            if (!target) return;
            openUsersForm("edit", target);
            return;
          }
          const action = btn.getAttribute("data-user-action");
          const id = btn.getAttribute("data-id");
          if (!id) return;

          if (action === "toggle") {
            await fetch(`/admin/users/${encodeURIComponent(id)}/toggle`, { method: "POST", credentials: "include" }).catch(() => null);
            await loadAdminUsers();
            return;
          }
          if (action === "edit") {
            const target = adminUsersCache.find((u) => String(u.id) === String(id));
            if (!target) return;
            openUsersForm("edit", target);
            return;
          }
          if (action === "reset") {
            const targetUser = adminUsersCache.find((u) => String(u.id) === String(id));
            const typed = prompt("Informe a nova senha do usuário:", "123456");
            if (typed === null) return;
            const newPassword = String(typed || "").trim();
            if (!newPassword) {
              alert("Senha não pode ficar vazia.");
              return;
            }
            if (newPassword.length < 6) {
              alert("A senha deve ter no mínimo 6 caracteres.");
              return;
            }
            const res = await fetch(`/admin/users/${encodeURIComponent(id)}/reset-password`, {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ newPassword }),
            }).catch(() => null);
            const out = res ? await res.json().catch(() => ({})) : null;
            if (!res || !res.ok || out?.ok === false) {
              alert(out?.error || out?.message || "Não foi possível resetar a senha.");
              return;
            }
            const updatedEmail = String(out?.user?.email || targetUser?.email || "").trim();
            const updatedPlain = String(out?.user?.password_plain || newPassword);
            if (updatedEmail) setPasswordVault(updatedEmail, updatedPlain);
            alert("Senha alterada com sucesso.");
            await loadAdminUsers();
            return;
          }
          if (action === "delete") {
            const ok = confirm("Deseja realmente excluir este usuário?");
            if (!ok) return;
            await fetch(`/admin/users/${encodeURIComponent(id)}`, {
              method: "DELETE",
              credentials: "include",
            }).catch(() => null);
            await loadAdminUsers();
          }
        });
      }

      if (createUserBtn) {
        createUserBtn.addEventListener("click", async () => {
          const name = (newUserName?.value || "").trim();
          const email = (newUserEmail?.value || "").trim();
          const password = newUserPass?.value || "";
          const role = (newUserRole?.value || "USER").toUpperCase() === "ADMIN" ? "ADMIN" : "USER";
          const company_name = (newUserCompany?.value || "").trim();
          const cnpj = (newUserCnpj?.value || "").trim();
          const whatsapp = (newUserWhatsapp?.value || "").trim();
          const plan = normalizePlanCode(newUserPlan?.value || "ESSENCIAL");
          const plan_value = Number(PLAN_VALUES[plan] || PLAN_VALUES.ESSENCIAL);
          const phoneDigits = whatsapp.replace(/\D/g, "");

          if (usersFormMode === "edit") {
            if (!email) {
              if (createUserMsg) createUserMsg.textContent = "Na edição, o email é obrigatório.";
              return;
            }
          } else {
            if (!name || !email || !password || !company_name || !cnpj || !whatsapp || !plan || !role) {
              if (createUserMsg) createUserMsg.textContent = "Para criar usuário, preencha todos os campos obrigatórios.";
              return;
            }
          }

          if (usersFormMode === "create" && password.length < 6) {
            if (createUserMsg) createUserMsg.textContent = "A senha deve ter no mínimo 6 caracteres.";
            return;
          }
          if (usersFormMode === "create") {
            if (!phoneDigits || phoneDigits.length < 10 || phoneDigits.length > 11) {
              if (createUserMsg) createUserMsg.textContent = "Informe WhatsApp válido com DDD + número.";
              return;
            }
          } else if (whatsapp && (phoneDigits.length < 10 || phoneDigits.length > 11)) {
            if (createUserMsg) createUserMsg.textContent = "Se informar WhatsApp na edição, ele deve ser válido.";
            return;
          }

          if (createUserMsg) createUserMsg.textContent = usersFormMode === "edit" ? "Salvando..." : "Criando usuário...";
          try {
            let payload;
            if (usersFormMode === "edit") {
              // Edicao: envia minimo necessario + somente campos preenchidos.
              payload = { email, plan, plan_value };
              if (name) payload.name = name;
              if (role) payload.role = role;
              if (company_name) payload.company_name = company_name;
              if (cnpj) payload.cnpj = cnpj;
              if (whatsapp) payload.whatsapp = whatsapp;
              if (password) payload.password = password;
            } else {
              payload = { name, email, role, company_name, cnpj, whatsapp, plan, plan_value, password };
            }
            const endpoint = usersFormMode === "edit" && usersEditId ? `/admin/users/${encodeURIComponent(usersEditId)}` : "/admin/users";
            const method = usersFormMode === "edit" ? "PUT" : "POST";

            const res = await fetch(endpoint, {
              method,
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const out = await res.json().catch(() => ({}));
            if (!res.ok || out?.ok === false) {
              const t = out?.error || out?.message || "";
              if (createUserMsg) createUserMsg.textContent = t || (usersFormMode === "edit" ? "Erro ao salvar usuário." : "Erro ao criar usuário.");
              return;
            }

            if (password && email) setPasswordVault(email, password);

            if (createUserMsg) createUserMsg.textContent = usersFormMode === "edit" ? "Usuário atualizado." : "Usuário criado.";
            if (newUserName) newUserName.value = "";
            if (newUserCompany) newUserCompany.value = "";
            if (newUserCnpj) newUserCnpj.value = "";
            if (newUserResponsible) newUserResponsible.value = "";
            if (newUserWhatsapp) newUserWhatsapp.value = "";
            if (newUserPlan) newUserPlan.value = "ESSENCIAL";
            if (newUserPlanValue) newUserPlanValue.value = formatMoneyBRL(PLAN_VALUES.ESSENCIAL);
            if (newUserEmail) newUserEmail.value = "";
            if (newUserPass) newUserPass.value = "";
            if (newUserRole) newUserRole.value = "USER";
            closeUsersForm();
            await loadAdminUsers();
          } catch (e) {
            if (createUserMsg) createUserMsg.textContent = usersFormMode === "edit" ? "Erro ao salvar usuário." : "Erro ao criar usuário.";
          }
        });
      }

      if (cfgTabProfile) cfgTabProfile.addEventListener("click", async () => { await setCfgTab("profile"); });
      if (cfgTabTerms) cfgTabTerms.addEventListener("click", async () => { await setCfgTab("terms"); });
      if (cfgTabPrivacy) cfgTabPrivacy.addEventListener("click", async () => { await setCfgTab("privacy"); });
      if (cfgTabPlans) cfgTabPlans.addEventListener("click", async () => { await setCfgTab("plans"); });
      if (cfgUpgradePlans && !cfgUpgradePlans.dataset.bound) {
        cfgUpgradePlans.dataset.bound = "1";
        cfgUpgradePlans.addEventListener("click", (ev) => {
          const btn = ev.target.closest("[data-plan-upgrade]");
          if (!btn) return;
          const planCode = normalizePlanCode(btn.getAttribute("data-plan-upgrade") || "");
          const planLabel = getPlanLabel(planCode);
          alert(`Solicitação de upgrade registrada para ${planLabel}. Nossa equipe vai entrar em contato para concluir.`);
        });
      }

      function wirePassToggle(btn, input) {
        if (!btn || !input || btn.dataset.bound) return;
        btn.dataset.bound = "1";
        const eyeIcon = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.8"/>
          </svg>
        `;
        const eyeOffIcon = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M2 12s3.5-6 10-6c2.4 0 4.4.8 6 1.9M22 12s-3.5 6-10 6c-2.4 0-4.4-.8-6-1.9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.8"/>
            <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        `;
        if (btn.dataset.iconToggle === "1") {
          btn.innerHTML = eyeIcon;
          btn.setAttribute("aria-label", "Mostrar senha");
          btn.setAttribute("title", "Mostrar senha");
        }
        btn.addEventListener("click", () => {
          const show = input.type === "password";
          input.type = show ? "text" : "password";
          if (btn.dataset.iconToggle === "1") {
            btn.innerHTML = show ? eyeOffIcon : eyeIcon;
            btn.setAttribute("aria-label", show ? "Ocultar senha" : "Mostrar senha");
            btn.setAttribute("title", show ? "Ocultar senha" : "Mostrar senha");
          } else {
            btn.textContent = show ? "Ocultar" : "Ver";
          }
        });
      }
      wirePassToggle(cfgPassToggle, cfgPass);
      wirePassToggle(cfgPass2Toggle, cfgPass2);
      wirePassToggle(newUserPassToggle, newUserPass);
      if (newUserWhatsapp) {
        newUserWhatsapp.addEventListener("input", () => {
          newUserWhatsapp.value = maskPhoneDigits(newUserWhatsapp.value);
        });
      }
      if (newUserPlan) {
        newUserPlan.addEventListener("change", () => {
          const p = normalizePlanCode(newUserPlan.value || "ESSENCIAL");
          if (newUserPlanValue) newUserPlanValue.value = formatMoneyBRL(PLAN_VALUES[p] || PLAN_VALUES.ESSENCIAL);
        });
      }
      if (newUserPassGenerate) {
        newUserPassGenerate.addEventListener("click", () => {
          const seed = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789";
          let out = "";
          for (let i = 0; i < 10; i += 1) out += seed[Math.floor(Math.random() * seed.length)];
          if (newUserPass) {
            newUserPass.value = out;
            newUserPass.type = "text";
          }
        });
      }

      if (usersOpenCreate) {
        usersOpenCreate.addEventListener("click", () => {
          if (!isAdminUser()) return;
          openUsersForm("create");
          if (newUserName) setTimeout(() => newUserName.focus(), 10);
        });
      }

      if (usersFormClose) usersFormClose.addEventListener("click", closeUsersForm);
      if (usersFormCancel) usersFormCancel.addEventListener("click", closeUsersForm);
      if (usersFormModal) {
        usersFormModal.addEventListener("click", (e) => {
          if (e.target === usersFormModal || e.target.classList.contains("modal-backdrop")) {
            closeUsersForm();
          }
        });
      }
      setInterval(() => {
        if (!isAdminUser()) return;
        if (document.hidden) return;
        const usersView = document.getElementById("view-usuarios");
        if (!usersView || usersView.classList.contains("hidden")) return;
        loadAdminUsers().catch(() => null);
      }, 8000);
      document.addEventListener("click", (ev) => {
        if (!usersCards) return;
        if (ev.target.closest(".crm-action-menu")) return;
        usersCards.querySelectorAll("[data-user-menu]").forEach((m) => m.classList.add("hidden"));
      });

      if (userMenuBtn && userMenuDropdown) {
        userMenuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          userMenuDropdown.classList.toggle("hidden");
        });
        document.addEventListener("click", (e) => {
          if (!userMenuDropdown.classList.contains("hidden")) {
            if (!userMenuDropdown.contains(e.target) && !userMenuBtn.contains(e.target)) {
              userMenuDropdown.classList.add("hidden");
            }
          }
        });
      }

      async function syncCurrentUserFromServer() {
        try {
          const res = await fetch("/auth/me", { credentials: "include" });
          if (!res.ok) return;
          const data = await res.json().catch(() => ({}));
          const serverUser = data?.user;
          if (!serverUser || typeof serverUser !== "object") return;
          currentUser = { ...currentUser, ...serverUser };
          try { localStorage.setItem("nfseUser", JSON.stringify(currentUser)); } catch (e) {}
        } catch (e) {}
      }

      async function openConfigModal() {
        if (!userConfigModal) return;
        await syncCurrentUserFromServer();
        if (cfgName) cfgName.value = currentUser.displayName || currentUser.name || "";
        if (cfgEmail) cfgEmail.value = currentUser.email || "";
        await setCfgTab("profile");
        if (cfgMsg) cfgMsg.textContent = "";
        userConfigModal.classList.remove("hidden");
        userConfigModal.classList.add("flex");
      }
      function closeConfigModal() {
        if (!userConfigModal) return;
        userConfigModal.classList.add("hidden");
        userConfigModal.classList.remove("flex");
      }

      if (userConfigBtn) {
        userConfigBtn.addEventListener("click", async () => {
          if (userMenuDropdown) userMenuDropdown.classList.add("hidden");
          await openConfigModal();
        });
      }
      if (userConfigClose) userConfigClose.addEventListener("click", closeConfigModal);
      if (userConfigModal) {
        userConfigModal.addEventListener("click", (e) => {
          if (e.target === userConfigModal || e.target.classList.contains("modal-backdrop")) {
            closeConfigModal();
          }
        });
      }

      if (userConfigSave) {
        userConfigSave.addEventListener("click", async () => {
          const name = (cfgName?.value || "").trim();
          const email = (cfgEmail?.value || "").trim();
          const pass = cfgPass?.value || "";
          const pass2 = cfgPass2?.value || "";

          if (!name || !email) {
            if (cfgMsg) cfgMsg.textContent = "Preencha nome e email.";
            return;
          }
          if ((pass || pass2) && pass !== pass2) {
            if (cfgMsg) cfgMsg.textContent = "As senhas não conferem.";
            return;
          }

          if (cfgMsg) cfgMsg.textContent = "Salvando...";
          try {
              const up = await fetch("/auth/update-profile", {
                method: "POST",
                credentials: "include",
                cache: "no-store",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, email }),
              });
            const upJson = await up.json().catch(() => ({}));
            if (!up.ok || upJson?.ok === false) {
              if (cfgMsg) cfgMsg.textContent = upJson?.message || upJson?.error || "Erro ao salvar perfil.";
              return;
            }

            if (pass) {
              const pw = await fetch("/auth/change-password", {
                method: "POST",
                credentials: "include",
                cache: "no-store",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newPassword: pass }),
              });
              const pwJson = await pw.json().catch(() => ({}));
              if (!pw.ok || pwJson?.ok === false) {
                if (cfgMsg) cfgMsg.textContent = pwJson?.message || pwJson?.error || "Erro ao alterar senha.";
                return;
              }
            }

              const savedName = String(upJson?.user?.name || name);
              const savedEmail = String(upJson?.user?.email || email);
              currentUser.name = savedName;
              currentUser.displayName = savedName;
              currentUser.email = savedEmail;
              try { localStorage.setItem("nfseUser", JSON.stringify(currentUser)); } catch (e) {}
              if (userNameDisplay) userNameDisplay.textContent = savedName;
              if (userAvatar) userAvatar.textContent = (savedName || "?").slice(0, 1).toUpperCase();
            if (cfgPass) cfgPass.value = "";
            if (cfgPass2) cfgPass2.value = "";
            if (cfgMsg) cfgMsg.textContent = "Salvo com sucesso.";
            setTimeout(closeConfigModal, 500);
          } catch (e) {
            if (cfgMsg) cfgMsg.textContent = "Falha ao salvar configurações.";
          }
        });
      }

      // logout (se seu backend existir)
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await fetch("/auth/logout", { method: "POST", credentials: "include" });
          } catch (e) {}
          localStorage.removeItem("nfseUser");
          window.location.href = "/index.html";
        });
      }

      // --------- NavegaÃƒÂ§ÃƒÂ£o de views ----------
      const titleEl = document.getElementById("pageTitle");
      const subtitleEl = document.getElementById("pageSubtitle");

      const meta = {
        "view-dashboard": { t: "Dashboard", s: "Visão geral do sistema de notas fiscais" },
        "view-empresas": { t: "Empresas", s: "Cadastro de empresas para captura e emissão" },
        "view-captura-individual": { t: "Captura de Notas", s: "Selecione uma ou mais empresas para capturar notas fiscais" },
        "view-captura-lote": { t: "Captura de Notas", s: "Selecione uma ou mais empresas para capturar notas fiscais" },
        "view-fila": { t: "Fila de Captura", s: "Acompanhe o progresso das capturas" },
        "view-downloads": { t: "Downloads", s: "Notas fiscais organizadas por empresa, prontas para download" },
        "view-historico": { t: "Histórico / Logs", s: "Registro completo de atividades de captura" },
        "view-emissao": { t: "Emissão NF-e", s: "Emissão de notas fiscais eletrônicas" },
        "view-usuarios": { t: "Gestão de Usuários", s: "Gerencie os acessos ao sistema" },
      };

      const mobileMenuToggleBtn = document.getElementById("mobileMenuToggleBtn");
      const mobileMenuCloseBtn = document.getElementById("mobileMenuCloseBtn");
      const mobileMenuBackdrop = document.getElementById("mobileMenuBackdrop");
      const mobileMq = window.matchMedia("(max-width: 860px)");
      const host = String(window.location.hostname || "").toLowerCase();
      const isLocalEnv =
        host === "localhost" ||
        host === "127.0.0.1" ||
        host === "::1" ||
        host.endsWith(".local");
      const emissaoEnabled = isLocalEnv;

      if (!emissaoEnabled) {
        document.querySelectorAll('[data-view="view-emissao"], [data-jump="view-emissao"]').forEach((el) => {
          el.classList.add("hidden");
        });
        const emissaoView = document.getElementById("view-emissao");
        if (emissaoView) emissaoView.classList.add("hidden");
      }
      function openMobileMenu() {
        if (!mobileMq.matches) return;
        document.body.classList.add("mobile-menu-open");
      }
      function closeMobileMenu() {
        document.body.classList.remove("mobile-menu-open");
      }
      if (mobileMenuToggleBtn && !mobileMenuToggleBtn.dataset.bound) {
        mobileMenuToggleBtn.dataset.bound = "1";
        mobileMenuToggleBtn.addEventListener("click", openMobileMenu);
      }
      if (mobileMenuCloseBtn && !mobileMenuCloseBtn.dataset.bound) {
        mobileMenuCloseBtn.dataset.bound = "1";
        mobileMenuCloseBtn.addEventListener("click", closeMobileMenu);
      }
      if (mobileMenuBackdrop && !mobileMenuBackdrop.dataset.bound) {
        mobileMenuBackdrop.dataset.bound = "1";
        mobileMenuBackdrop.addEventListener("click", closeMobileMenu);
      }
      if (mobileMq && mobileMq.addEventListener) {
        mobileMq.addEventListener("change", () => {
          if (!mobileMq.matches) closeMobileMenu();
        });
      }
      document.addEventListener("keydown", (ev) => {
        if (ev.key === "Escape") closeMobileMenu();
      });

      function showView(id) {
        if (id === "view-captura-individual") {
          id = "view-captura-lote";
        }
        if (id === "view-emissao" && !emissaoEnabled) {
          id = "view-dashboard";
        }
        if (id === "view-usuarios" && !isAdminUser()) {
          id = "view-dashboard";
        }
        Object.keys(meta).forEach((k) => {
          const el = document.getElementById(k);
          if (el) el.classList.add("hidden");
        });

        const current = document.getElementById(id);
        if (current) current.classList.remove("hidden");

        document.querySelectorAll("[data-view]").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.view === id);
        });

        if (titleEl) titleEl.textContent = meta[id]?.t || "Painel";
        if (subtitleEl) subtitleEl.textContent = meta[id]?.s || "";

        if (id === "view-historico") renderHistoricoFromStorage(true);
        if (id === "view-downloads") renderDownloads();
        if (id === "view-usuarios") loadAdminUsers();
        closeMobileMenu();
      }

      function applyHistoricoQuickFilter(levelText) {
        const filtroEl = document.getElementById("historicoFiltro");
        if (!filtroEl) return;
        const wanted = String(levelText || "Todos").trim().toLowerCase();
        const option = Array.from(filtroEl.options || []).find(
          (o) => String(o.value || o.textContent || "").trim().toLowerCase() === wanted
        );
        filtroEl.value = option ? option.value : "Todos";
      }

      fetch("/auth/me", { credentials: "include" })
        .then((r) => (r.ok ? r.json() : Promise.reject(new Error("Sessão inválida"))))
        .then((j) => {
          const u = j?.user || null;
          if (!u) throw new Error("Usuário não autenticado");
          currentUser = { ...currentUser, ...u };
          if (adminMenuBlock && !isAdminUser()) adminMenuBlock.classList.add("hidden");
          renderClientPlanBadge();
          try { localStorage.setItem("nfseUser", JSON.stringify(currentUser)); } catch (_) {}
        })
        .catch(() => {
          try { localStorage.removeItem("nfseUser"); } catch (_) {}
          window.location.href = "/index.html";
        });

      document.querySelectorAll("[data-view]").forEach((btn) => {
        btn.addEventListener("click", () => showView(btn.dataset.view));
      });

      document.querySelectorAll("[data-jump]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetView = btn.dataset.jump;
          const histFilter = btn.dataset.historicoFiltro || "";
          if (targetView === "view-historico") {
            applyHistoricoQuickFilter(histFilter || "Todos");
          }
          showView(targetView);
          if (targetView === "view-historico") renderHistoricoFromStorage(true);
        });
      });

      // --------- Modal empresa ----------
      const modal = document.getElementById("modalEmpresa");
      const btnNovaEmpresa = document.getElementById("btnNovaEmpresa");
      const modalClose = document.getElementById("modalEmpresaClose");
      const modalCancel = document.getElementById("modalEmpresaCancel");
      const modalBackdrop = modal ? modal.querySelector(".modal-backdrop") : null;

      function openModal() {
        if (!modal) return;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      function closeModal() {
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      if (btnNovaEmpresa) btnNovaEmpresa.addEventListener("click", () => {
        resetEmpresaForm();
        openModal();
      });
      if (modalClose) modalClose.addEventListener("click", closeModal);
      if (modalCancel) modalCancel.addEventListener("click", closeModal);
      if (modalBackdrop) modalBackdrop.addEventListener("click", closeModal);

      // mostrar/ocultar senha
      const toggleEmpresaSenha = document.getElementById("toggleEmpresaSenha");
      const empresaSenha = document.getElementById("empresaSenha");
      if (toggleEmpresaSenha && empresaSenha) {
        toggleEmpresaSenha.addEventListener("click", () => {
          empresaSenha.type = empresaSenha.type === "password" ? "text" : "password";
        });
      }
      const empresaAuthType = document.getElementById("empresaAuthType");
      const empresaTelefone = document.getElementById("empresaTelefone");
      if (empresaAuthType) {
        empresaAuthType.addEventListener("change", updateEmpresaAuthBlocks);
      }
      if (empresaTelefone) {
        empresaTelefone.addEventListener("input", () => {
          const d = String(empresaTelefone.value || "").replace(/\D/g, "").slice(0, 11);
          if (d.length <= 2) empresaTelefone.value = d;
          else if (d.length <= 6) empresaTelefone.value = `(${d.slice(0, 2)}) ${d.slice(2)}`;
          else if (d.length <= 10) empresaTelefone.value = `(${d.slice(0, 2)}) ${d.slice(2, 6)}-${d.slice(6)}`;
          else empresaTelefone.value = `(${d.slice(0, 2)}) ${d.slice(2, 7)}-${d.slice(7)}`;
        });
      }

      // --------- Tema ----------
      (function () {
        const KEY = "nfseTheme";
        const btn = document.getElementById("themeToggleBtn");
        function apply(theme) {
          const isDark = theme === "dark";
          document.documentElement.classList.toggle("dark", isDark);
          try {
            localStorage.setItem(KEY, isDark ? "dark" : "light");
          } catch (e) {}
        }
        function toggle() {
          const nowDark = document.documentElement.classList.contains("dark");
          apply(nowDark ? "light" : "dark");
        }
        if (btn && !btn.dataset.bound) {
          btn.dataset.bound = "1";
          btn.addEventListener("click", toggle);
        }

        window.addEventListener("pageshow", () => {
          let saved = "dark";
          try {
            saved = localStorage.getItem(KEY) || "dark";
          } catch (e) {}
          apply(saved);
        });
      })();

      // --------- Instalação do app (PWA) ----------
      (function () {
        const btn = document.getElementById("installAppBtn");
        if (!btn) return;

        let deferredPrompt = window.__deferredInstallPrompt || null;
        const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent || "");
        const isStandalone =
          window.matchMedia?.("(display-mode: standalone)")?.matches || window.navigator.standalone === true;

        if ("serviceWorker" in navigator) {
          window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js").catch(() => {});
          });
        }

        window.addEventListener("nfse-install-available", () => {
          deferredPrompt = window.__deferredInstallPrompt || null;
        });

        window.addEventListener("appinstalled", () => {
          deferredPrompt = null;
          window.__deferredInstallPrompt = null;
          btn.textContent = "App Instalado";
        });

        if (!btn.dataset.bound) {
          btn.dataset.bound = "1";
          btn.addEventListener("click", async () => {
            if (isStandalone) {
              alert("Aplicativo já instalado neste dispositivo.");
              return;
            }

            if (deferredPrompt) {
              deferredPrompt.prompt();
              try {
                const choice = await deferredPrompt.userChoice;
                if (choice?.outcome === "accepted") return;
              } catch (e) {}
            }

            if (isIOS) {
              alert("No iPhone/iPad: toque em Compartilhar e depois em 'Adicionar à Tela de Início' para instalar o app.");
              return;
            }

            alert("No computador ou Android: abra o menu do navegador e use 'Instalar aplicativo' ou 'Adicionar à área de trabalho'.");
          });
        }
      })();

      // =========================
      // ✅ EMPRESAS (CRUD simples no front)
      // =========================
      const KEY_EMPRESAS = `nfseEmpresas:${(currentUser.email || "anon").toString().toLowerCase()}`;
      const empresasGrid = document.getElementById("empresasGrid");
      const empresasSearch = document.getElementById("empresasSearch");

      function loadEmpresas() {
        try {
          const raw = localStorage.getItem(KEY_EMPRESAS);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch (e) {
          return [];
        }
      }

      function saveEmpresas(list) {
        try {
          localStorage.setItem(KEY_EMPRESAS, JSON.stringify(list || []));
        } catch (e) {}
      }

      function formatCNPJ(v) {
        const d = (v || "").toString().replace(/\D/g, "").slice(0, 14);
        if (d.length !== 14) return v || "";
        return d.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2}).*$/, "$1.$2.$3/$4-$5");
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          try {
            const reader = new FileReader();
            reader.onload = () => {
              const raw = String(reader.result || "");
              const base64 = raw.includes(",") ? raw.split(",").pop() : raw;
              resolve(base64 || "");
            };
            reader.onerror = () => reject(new Error("Falha ao ler arquivo do certificado."));
            reader.readAsDataURL(file);
          } catch (e) {
            reject(e);
          }
        });
      }

      function resetEmpresaForm() {
        document.getElementById("empresaId").value = "";
        document.getElementById("empresaNome").value = "";
        document.getElementById("empresaCnpj").value = "";
        document.getElementById("empresaRazaoSocial").value = "";
        document.getElementById("empresaIe").value = "";
        document.getElementById("empresaUf").value = "";
        document.getElementById("empresaCidade").value = "";
        document.getElementById("empresaEndereco").value = "";
        document.getElementById("empresaTelefone").value = "";
        document.getElementById("empresaEmail").value = "";
        document.getElementById("empresaStatus").value = "ATIVO";
        document.getElementById("empresaAuthType").value = "Login e Senha";
        document.getElementById("empresaLogin").value = "";
        document.getElementById("empresaSenha").value = "";
        const certInput = document.getElementById("empresaCertFile");
        if (certInput) {
          certInput.value = "";
          certInput.dataset.current = "";
        }
        const certCurrent = document.getElementById("empresaCertCurrent");
        if (certCurrent) certCurrent.textContent = "";
        document.getElementById("empresaCertPass").value = "";
        const t = document.getElementById("modalEmpresaTitle");
        if (t) t.textContent = "Cadastrar Empresa";
        const b = document.getElementById("modalEmpresaSave");
        if (b) b.textContent = "Cadastrar";
        updateEmpresaAuthBlocks();
      }

      function fillEmpresaForm(emp) {
        document.getElementById("empresaId").value = emp.id || "";
        document.getElementById("empresaNome").value = emp.nome || "";
        document.getElementById("empresaCnpj").value = emp.cnpj || "";
        document.getElementById("empresaRazaoSocial").value = emp.razaoSocial || "";
        document.getElementById("empresaIe").value = emp.inscricaoEstadual || "";
        document.getElementById("empresaUf").value = emp.uf || "";
        document.getElementById("empresaCidade").value = emp.cidade || "";
        document.getElementById("empresaEndereco").value = emp.endereco || "";
        document.getElementById("empresaTelefone").value = emp.telefone || "";
        document.getElementById("empresaEmail").value = emp.email || "";
        document.getElementById("empresaStatus").value = (emp.status || "ATIVO").toUpperCase();
        document.getElementById("empresaAuthType").value = emp.authType || "Login e Senha";
        document.getElementById("empresaLogin").value = emp.portalLogin || "";
        document.getElementById("empresaSenha").value = emp.portalSenha || "";
        const certInput = document.getElementById("empresaCertFile");
        if (certInput) {
          certInput.value = "";
          certInput.dataset.current = emp.certPfxPath || emp.pfxPath || emp.certFile || "";
        }
        const certCurrent = document.getElementById("empresaCertCurrent");
        if (certCurrent) {
          const currentPath = emp.certPfxPath || emp.pfxPath || emp.certFile || "";
          const baseName = currentPath ? currentPath.split(/[\\/]/).pop() : "";
          certCurrent.textContent = baseName ? `Arquivo atual: ${baseName}` : "";
        }
        document.getElementById("empresaCertPass").value = emp.certPassphrase || emp.passphrase || emp.certPass || "";

        const t = document.getElementById("modalEmpresaTitle");
        if (t) t.textContent = "Editar Empresa";
        const b = document.getElementById("modalEmpresaSave");
        if (b) b.textContent = "Salvar";
        updateEmpresaAuthBlocks();
      }

      function updateEmpresaAuthBlocks() {
        const authType = (document.getElementById("empresaAuthType")?.value || "Login e Senha").toLowerCase();
        const isCert = authType.includes("certificado");
        const loginBlock = document.getElementById("empresaAuthLoginBlock");
        const certBlock = document.getElementById("empresaAuthCertBlock");
        if (loginBlock) loginBlock.classList.toggle("hidden", isCert);
        if (certBlock) certBlock.classList.toggle("hidden", !isCert);
      }

      function renderEmpresas() {
        const q = (empresasSearch?.value || "").toString().trim().toLowerCase();
        const list = loadEmpresas().filter((e) => {
          const nome = (e.nome || "").toString().toLowerCase();
          const razao = (e.razaoSocial || "").toString().toLowerCase();
          const cnpj = (e.cnpj || "").toString().toLowerCase();
          if (!q) return true;
          return nome.includes(q) || razao.includes(q) || cnpj.includes(q);
        });

        if (empresasGrid) {
          empresasGrid.innerHTML = "";
          if (!list.length) {
            empresasGrid.innerHTML = `
              <div class="glass-strong rounded-xl2 p-5">
                <p class="text-sm text-white/60">Nenhuma empresa cadastrada ainda.</p>
              </div>
            `;
          } else {
            for (const emp of list) {
              const statusBadge = emp.ativa !== false ? "Ativa" : "Inativa";
              const statusStyle =
                emp.ativa !== false
                  ? 'background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.25);'
                  : 'background: rgba(239,68,68,.14); border:1px solid rgba(239,68,68,.25);';

              const authLabel = (emp.authType || "Login e Senha").toString();

              const card = document.createElement("div");
              card.className = "glass-strong rounded-xl2 p-4 flex items-center gap-3 relative";
              card.innerHTML = `
                <div class="flex items-center gap-3 min-w-0 pr-12">
                  <div class="h-11 w-11 rounded-2xl flex items-center justify-center shrink-0"
                    style="background: color-mix(in srgb, var(--sidebar-active) 88%, transparent); border:1px solid var(--line);">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M4 20V6a2 2 0 0 1 2-2h6v16H4Zm10 0V4h4a2 2 0 0 1 2 2v14h-6Z" stroke="currentColor" stroke-width="1.8" />
                      <path d="M7 8h2M7 12h2M7 16h2" stroke="currentColor" stroke-width="1.8" opacity="0.65" />
                    </svg>
                  </div>
                  <div class="min-w-0 flex flex-col justify-center">
                    <p class="text-base font-semibold truncate">${emp.nome || "-"}</p>
                    <p class="text-sm text-white/50">${emp.cnpj || "-"}</p>
                    <p class="text-sm text-white/60 mt-0.5 truncate">${emp.razaoSocial || "-"}</p>
                    <div class="mt-2 inline-flex items-center gap-2 text-xs flex-wrap">
                    <span class="px-3 py-1 rounded-full" style="${statusStyle}">${statusBadge}</span>
                    <span class="text-white/40">•</span>
                    <span class="text-white/55">${authLabel}</span>
                    <span class="text-white/40">•</span>
                    <span class="text-white/55">${emp.uf || "-"}</span>
                    </div>
                  </div>
                </div>
                <div class="absolute right-3 top-3 z-10">
                  <button
                    class="btn-ghost h-11 w-11 rounded-full inline-flex items-center justify-center border border-white/15"
                    data-action="menu-toggle"
                    data-id="${emp.id}"
                    aria-label="Ações da empresa"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M12 5h.01M12 12h.01M12 19h.01" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" />
                    </svg>
                  </button>
                  <div class="hidden absolute right-12 top-1/2 -translate-y-1/2 min-w-[185px] rounded-xl2 p-2 z-20 border border-white/10 shadow-[0_12px_30px_rgba(0,0,0,.25)] bg-[var(--panel)]" data-company-menu="${emp.id}">
                    <button class="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-white/10 flex items-center gap-2.5" data-action="edit" data-id="${emp.id}">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M4 20h4l10-10-4-4L4 16v4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" />
                        <path d="m12.5 7.5 4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                      </svg>
                      <span class="text-sm">Editar</span>
                    </button>
                    <button class="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-white/10 flex items-center gap-2.5 font-semibold" data-action="delete" data-id="${emp.id}" style="color:#ef4444;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M3 6h18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M6 6l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13" stroke="currentColor" stroke-width="1.8" />
                        <path d="M10 10v7M14 10v7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                      </svg>
                      <span class="text-sm font-semibold">Remover</span>
                    </button>
                  </div>
                </div>
              `;
              empresasGrid.appendChild(card);
            }
          }
        }

        // KPI empresas
        const all = loadEmpresas();
        const k = document.getElementById("kpiEmpresas");
        if (k) k.textContent = String(all.length || 0);

        // atualiza lista do lote
        renderLoteEmpresas();

        // ✅ atualiza select da captura individual
        renderCapturaIndividualEmpresas();
      }

      if (empresasSearch) empresasSearch.addEventListener("input", renderEmpresas);

      // eventos de editar/excluir (delegation)
      if (empresasGrid) {
        empresasGrid.addEventListener("click", (ev) => {
          const btn = ev.target?.closest?.("button[data-action]");
          if (!btn) return;

          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          if (!id) return;

          if (action === "menu-toggle") {
            const menu = empresasGrid.querySelector(`[data-company-menu="${id}"]`);
            empresasGrid.querySelectorAll("[data-company-menu]").forEach((m) => {
              if (m !== menu) m.classList.add("hidden");
            });
            if (menu) menu.classList.toggle("hidden");
            return;
          }

          if (action === "delete") {
            const list = loadEmpresas().filter((e) => e.id !== id);
            saveEmpresas(list);
            renderEmpresas();
            updateCapturaLoteButton();
            updateCapturaIndividualButton();
            return;
          }

          if (action === "edit") {
            const emp = loadEmpresas().find((e) => e.id === id);
            if (!emp) return;
            fillEmpresaForm(emp);
            openModal();
            return;
          }
        });

        document.addEventListener("click", (ev) => {
          const target = ev.target;
          const insideGrid = target && empresasGrid.contains(target);
          if (!insideGrid) {
            empresasGrid.querySelectorAll("[data-company-menu]").forEach((m) => m.classList.add("hidden"));
            return;
          }
          if (!target.closest("[data-action='menu-toggle']") && !target.closest("[data-company-menu]")) {
            empresasGrid.querySelectorAll("[data-company-menu]").forEach((m) => m.classList.add("hidden"));
          }
        });
      }

      // salvar empresa
      const modalEmpresaSave = document.getElementById("modalEmpresaSave");
      if (modalEmpresaSave) {
        modalEmpresaSave.addEventListener("click", async () => {
          const id = document.getElementById("empresaId").value || "";
          const empresaRecordId = id || `emp_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          const nome = document.getElementById("empresaNome").value.trim();
          const cnpjRaw = document.getElementById("empresaCnpj").value.trim();
          const cnpj = formatCNPJ(cnpjRaw);
          const razaoSocial = document.getElementById("empresaRazaoSocial").value.trim();
          const inscricaoEstadual = document.getElementById("empresaIe").value.trim();
          const uf = document.getElementById("empresaUf").value.trim();
          const cidade = document.getElementById("empresaCidade").value.trim();
          const endereco = document.getElementById("empresaEndereco").value.trim();
          const telefone = document.getElementById("empresaTelefone").value.trim();
          const email = document.getElementById("empresaEmail").value.trim();
          const status = document.getElementById("empresaStatus").value.trim().toUpperCase() || "ATIVO";
          const authType = document.getElementById("empresaAuthType").value.trim();
          const portalLogin = document.getElementById("empresaLogin").value.trim();
          const portalSenha = document.getElementById("empresaSenha").value;
          const certInput = document.getElementById("empresaCertFile");
          const certPass = document.getElementById("empresaCertPass").value.trim();
          let certPfxPath = certInput?.dataset?.current || "";
          let certPassphrase = certPass || "";
          const ativa = status === "ATIVO";

          if (!nome || !cnpj) {
            alert("Preencha pelo menos Nome da Empresa e CNPJ.");
            return;
          }

          const isCert = String(authType || "").toLowerCase().includes("certificado");
          if (!isCert && (!portalLogin || !portalSenha)) {
            alert("Para Login e Senha, preencha as credenciais do portal.");
            return;
          }
          if (isCert) {
            const selectedFile = certInput?.files?.[0] || null;
            const looksLikeServerPath = /[\\/]/.test(String(certPfxPath || ""));
            if (selectedFile) {
              if (!certPassphrase) {
                alert("Informe a senha do certificado A1.");
                return;
              }
              try {
                const pfxBase64 = await fileToBase64(selectedFile);
                const resp = await fetch("/api/nf/certificado", {
                  method: "POST",
                  credentials: "include",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    usuarioEmail: currentUser?.email || "",
                    empresaId: empresaRecordId,
                    filename: selectedFile.name,
                    pfxBase64,
                    passphrase: certPassphrase,
                  }),
                });
                const j = await resp.json().catch(() => ({}));
                if (!resp.ok || !j?.ok || !j?.certPfxPath) {
                  throw new Error(j?.error || "Falha ao salvar certificado A1.");
                }
                certPfxPath = j.certPfxPath;
              } catch (err) {
                alert(err?.message || "Erro ao salvar certificado A1.");
                return;
              }
            } else if (!certPfxPath || !looksLikeServerPath) {
              alert("Certificado A1 não está salvo no servidor. Reenvie o arquivo (.pfx/.p12) nesta empresa.");
              return;
            } else if (!certPassphrase) {
              alert("Informe a senha do certificado A1.");
              return;
            }
          }

          const list = loadEmpresas();
          if (id) {
            const idx = list.findIndex((e) => e.id === id);
            if (idx >= 0) {
              list[idx] = {
                ...list[idx],
                nome, cnpj, razaoSocial, inscricaoEstadual, uf, cidade, endereco, telefone, email, status, authType, portalLogin, portalSenha, ativa,
                certPfxPath: certPfxPath || list[idx].certPfxPath || list[idx].pfxPath || "",
                certPassphrase: certPassphrase || list[idx].certPassphrase || list[idx].passphrase || "",
                pfxPath: certPfxPath || list[idx].pfxPath || "",
                passphrase: certPassphrase || list[idx].passphrase || "",
                certFile: certPfxPath || list[idx].certFile || "",
                certPass: certPassphrase || list[idx].certPass || "",
              };
            }
          } else {
            list.push({
              id: empresaRecordId, nome, cnpj, razaoSocial, inscricaoEstadual, uf, cidade, endereco, telefone, email, status, authType, portalLogin, portalSenha, ativa,
              certPfxPath: certPfxPath || "",
              certPassphrase: certPassphrase || "",
              pfxPath: certPfxPath || "",
              passphrase: certPassphrase || "",
              certFile: certPfxPath || "",
              certPass: certPassphrase || "",
            });
          }

          saveEmpresas(list);
          closeModal();
          renderEmpresas();
          updateCapturaLoteButton();
          updateCapturaIndividualButton();
        });
      }

      // =========================
      // ✅ CAPTURA EM LOTE (habilita botão + contagem + ação)
      // =========================
      const loteEmpresasList = document.getElementById("loteEmpresasList");
      const btnSelecionarTodasLote = document.getElementById("btnSelecionarTodasLote");
      const btnCapturarLote = document.getElementById("btnCapturarLote");
      const labelCapturarLote = document.getElementById("labelCapturarLote");

      function renderLoteEmpresas() {
        if (!loteEmpresasList) return;

        const list = loadEmpresas();
        loteEmpresasList.innerHTML = "";

        if (!list.length) {
          loteEmpresasList.innerHTML = `
            <div class="glass-strong rounded-xl2 p-4">
              <p class="text-sm text-white/60">Cadastre uma empresa para habilitar a captura de notas.</p>
            </div>
          `;
          updateCapturaLoteButton();
          return;
        }

        for (const emp of list) {
          const lbl = document.createElement("label");
          lbl.className = "glass-strong rounded-xl2 p-4 flex items-center gap-3 cursor-pointer";
          lbl.innerHTML = `
            <input type="checkbox" class="h-4 w-4 accent-[rgb(109,94,247)]" data-emp-id="${emp.id}" />
            <div>
              <p class="text-sm font-semibold">${emp.nome || "-"}</p>
              <p class="text-xs text-white/45">${emp.cnpj || "-"}</p>
            </div>
          `;
          loteEmpresasList.appendChild(lbl);
        }

        // listener para atualizar o botÃƒÂ£o quando marca/desmarca
        loteEmpresasList.querySelectorAll('input[type="checkbox"][data-emp-id]').forEach((cb) => {
          cb.addEventListener("change", updateCapturaLoteButton);
        });

        updateCapturaLoteButton();
      }

      function getSelectedEmpresaIdsLote() {
        if (!loteEmpresasList) return [];
        return Array.from(loteEmpresasList.querySelectorAll('input[type="checkbox"][data-emp-id]:checked')).map((x) => x.getAttribute("data-emp-id")).filter(Boolean);
      }

      function updateCapturaLoteButton() {
        const ids = getSelectedEmpresaIdsLote();
        const n = ids.length;

        if (labelCapturarLote) labelCapturarLote.textContent = n === 1 ? "Capturar 1 Empresa" : `Capturar ${n} Empresa(s)`;

        if (btnCapturarLote) {
          if (n > 0) {
            btnCapturarLote.disabled = false;
            btnCapturarLote.classList.remove("opacity-70");
          } else {
            btnCapturarLote.disabled = true;
            btnCapturarLote.classList.add("opacity-70");
          }
        }
      }

      if (btnSelecionarTodasLote) {
        btnSelecionarTodasLote.addEventListener("click", () => {
          if (!loteEmpresasList) return;
          const all = Array.from(loteEmpresasList.querySelectorAll('input[type="checkbox"][data-emp-id]'));
          const anyUnchecked = all.some((x) => !x.checked);
          all.forEach((x) => (x.checked = anyUnchecked));
          updateCapturaLoteButton();
        });
      }

      // aÃƒÂ§ÃƒÂ£o de captura (front: registra no "fila" e no "histÃƒÂ³rico")
      const KEY_FILA = `nfseFila:${(currentUser.email || "anon").toString().toLowerCase()}`;
      const KEY_HIST = `nfseHistorico:${(currentUser.email || "anon").toString().toLowerCase()}`;
      const KEY_DOWNLOADS = `nfseDownloads:${(currentUser.email || "anon").toString().toLowerCase()}`;

      function loadList(key) {
        try {
          const raw = localStorage.getItem(key);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch (e) {
          return [];
        }
      }
      function saveList(key, arr) {
        try {
          localStorage.setItem(key, JSON.stringify(arr || []));
        } catch (e) {}
      }

      function nowISO() {
        return new Date().toISOString();
      }

      function extractZipName(zipUrl) {
        try {
          const clean = String(zipUrl || "").split("?")[0];
          return clean.split("/").pop() || "";
        } catch (e) {
          return "";
        }
      }

      function addDownloadRecord(item) {
        const list = loadList(KEY_DOWNLOADS);
        list.unshift({
          id: `dl_${Date.now()}_${Math.random().toString(16).slice(2)}`
          ,createdAt: nowISO()
          ,tipo: item?.tipo || "captura"
          ,empresa: item?.empresa || ""
          ,zipUrl: item?.zipUrl || ""
          ,zipName: item?.zipName || extractZipName(item?.zipUrl || "")
        });
        saveList(KEY_DOWNLOADS, list.slice(0, 200));
      }

      async function removeDownloadRecord(id) {
        const list = loadList(KEY_DOWNLOADS);
        const found = list.find((x) => x.id === id);
        const next = list.filter((x) => x.id !== id);
        saveList(KEY_DOWNLOADS, next);

        const zipName = found?.zipName || extractZipName(found?.zipUrl || "");
        if (zipName) {
          try {
            await fetch(`/api/zips/${encodeURIComponent(zipName)}`, { method: "DELETE", credentials: "include" });
          } catch (e) {}
        }
      }

      function renderDownloads() {
        const box = document.getElementById("downloadsContainer");
        if (!box) return;

        const items = loadList(KEY_DOWNLOADS);
        if (!items.length) {
          box.innerHTML = `
            <div class="h-full min-h-[360px] flex items-center justify-center">
              <div class="text-center text-white/45">
                <div class="mx-auto mb-3 text-white/35">
                  <svg width="38" height="38" viewBox="0 0 24 24" fill="none">
                    <path d="M12 3v10m0 0 3-3m-3 3-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M5 17v3h14v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <p class="text-sm">Nenhum download disponível</p>
                <p class="text-xs text-white/35 mt-1">As capturas concluídas aparecerão aqui</p>
              </div>
            </div>
          `;
          return;
        }

        box.innerHTML = `
          <div class="space-y-3">
            ${items.map((x) => `
              <div class="glass-strong rounded-xl2 p-4 flex items-center justify-between gap-4">
                <div>
                  <p class="text-sm font-semibold">${x.tipo === "captura_lote" ? "Captura em Lote" : "Captura Individual"}</p>
                  <p class="text-xs text-white/45 mt-1">${x.empresa || "-"}</p>
                  <p class="text-xs text-white/35 mt-1">${x.zipName || x.zipUrl || "-"}</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="btn-ghost px-3 py-2 rounded-xl2 text-sm" data-download-action="baixar" data-id="${x.id}">Baixar</button>
                  <button class="btn-ghost px-3 py-2 rounded-xl2 text-sm" data-download-action="excluir" data-id="${x.id}" style="border-color: rgba(239,68,68,.25); color: rgba(239,68,68,.95);">Excluir</button>
                </div>
              </div>
            `).join("")}
          </div>
        `;
      }

      const downloadsContainer = document.getElementById("downloadsContainer");
      if (downloadsContainer && !downloadsContainer.dataset.bound) {
        downloadsContainer.dataset.bound = "1";
        downloadsContainer.addEventListener("click", async (ev) => {
          const btn = ev.target.closest("button[data-download-action][data-id]");
          if (!btn) return;
          const action = btn.getAttribute("data-download-action");
          const id = btn.getAttribute("data-id");
          const items = loadList(KEY_DOWNLOADS);
          const item = items.find((x) => x.id === id);
          if (!item) return;

          if (action === "baixar") {
            baixarZip(item.zipUrl);
            return;
          }

          if (action === "excluir") {
            await removeDownloadRecord(id);
            renderDownloads();
          }
        });
      }

      function updateKPIsFromStorage() {
        const fila = loadList(KEY_FILA);
        const hist = loadList(KEY_HIST);
        const kFila = document.getElementById("kpiFila");
        if (kFila) kFila.textContent = String(fila.length || 0);
        const concluidas = hist.filter((x) => x?.status === "concluida").length;
        const kConcl = document.getElementById("kpiConcluidas");
        if (kConcl) kConcl.textContent = String(concluidas || 0);
        const erros = hist.filter((x) => x?.status === "erro").length;
        const kErros = document.getElementById("kpiErros");
        if (kErros) kErros.textContent = String(erros || 0);
        renderDashboardResumo();
      }

      function formatDashDate(v) {
        const d = new Date(v || Date.now());
        if (Number.isNaN(d.getTime())) return "-";
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${dd}/${mm} ${hh}:${mi}`;
      }

      function renderDashboardResumo() {
        const recentesBox = document.getElementById("dashboardRecentesContainer");
        const recentesEmpty = document.getElementById("dashboardRecentesEmpty");
        const logsBox = document.getElementById("dashboardLogsContainer");
        const logsEmpty = document.getElementById("dashboardLogsEmpty");
        if (!recentesBox || !logsBox) return;

        const fila = loadList(KEY_FILA).slice(0, 5);
        const hist = loadList(KEY_HIST);
        const logs = hist.slice(0, 5);

        if (!fila.length) {
          recentesBox.innerHTML = "";
          if (recentesEmpty) recentesEmpty.classList.remove("hidden");
        } else {
          if (recentesEmpty) recentesEmpty.classList.add("hidden");
          recentesBox.innerHTML = fila
            .map((j) => {
              const empresas = (j.empresas || []).map((e) => e.nome).filter(Boolean).join(", ");
              const label =
                j.tipo === "captura_lote"
                  ? `Captura em lote${empresas ? ` - ${empresas}` : ""}`
                  : `Captura individual${empresas ? ` - ${empresas}` : ""}`;
              const status = String(j.status || "na_fila").toLowerCase();
              const statusLabel =
                status === "concluida" ? "Concluído" : status === "erro" ? "Erro" : "Na fila";
              const statusStyle =
                status === "concluida"
                  ? "background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.28)"
                  : status === "erro"
                  ? "background: rgba(239,68,68,.14); border:1px solid rgba(239,68,68,.28)"
                  : "background: rgba(245,158,11,.14); border:1px solid rgba(245,158,11,.28)";
              return `
                <button type="button" class="w-full text-left glass-strong rounded-xl2 p-3 hover:brightness-110 transition" data-jump="view-fila">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <p class="text-sm font-semibold">${label || "-"}</p>
                      <p class="text-xs text-white/45 mt-1">${formatDashDate(j.createdAt)}</p>
                    </div>
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold" style="${statusStyle}">${statusLabel}</span>
                  </div>
                </button>
              `;
            })
            .join("");
        }

        if (!logs.length) {
          logsBox.innerHTML = "";
          if (logsEmpty) logsEmpty.classList.remove("hidden");
        } else {
          if (logsEmpty) logsEmpty.classList.add("hidden");
          logsBox.innerHTML = logs
            .map((x) => {
              const level = x.level || "Info";
              const levelStyle =
                level === "Sucesso"
                  ? "background: rgba(34, 197, 94, 0.14); border: 1px solid rgba(34, 197, 94, 0.28)"
                  : level === "Erro"
                  ? "background: rgba(239, 68, 68, 0.14); border: 1px solid rgba(239, 68, 68, 0.28)"
                  : "background: rgba(59, 130, 246, 0.14); border: 1px solid rgba(59, 130, 246, 0.28)";
              return `
                <button type="button" class="w-full text-left hover:brightness-110 transition" data-jump="view-historico" data-historico-filtro="${level}">
                  <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                      <span class="px-3 py-1 rounded-full text-xs font-semibold" style="${levelStyle}">${level}</span>
                      <p class="text-sm text-white/85 truncate">${x.message || "-"}</p>
                    </div>
                    <span class="text-xs text-white/45 whitespace-nowrap">${formatDashDate(x.createdAt)}</span>
                  </div>
                </button>
              `;
            })
            .join("");
        }

        [recentesBox, logsBox].forEach((box) => {
          if (!box || box.dataset.bound === "1") return;
          box.dataset.bound = "1";
          box.addEventListener("click", (ev) => {
            const btn = ev.target.closest("[data-jump]");
            if (!btn) return;
            const v = btn.getAttribute("data-jump");
            if (v === "view-historico") {
              applyHistoricoQuickFilter(btn.getAttribute("data-historico-filtro") || "Todos");
            }
            if (v) showView(v);
            if (v === "view-historico") renderHistoricoFromStorage(true);
          });
        });
      }

      if (btnCapturarLote) {
        btnCapturarLote.addEventListener("click", async () => {
          const ids = getSelectedEmpresaIdsLote();
          if (!ids.length) return;
          const empresas = loadEmpresas().filter((e) => ids.includes(e.id));

          const invalidCertEmp = empresas.find((e) => {
            const auth = String(e?.authType || "").toLowerCase();
            if (!auth.includes("certificado")) return false;
            const certPath = String(e?.certPfxPath || e?.pfxPath || e?.certFile || "").trim();
            const certPass = String(e?.certPassphrase || e?.passphrase || e?.certPass || "").trim();
            const looksLikeServerPath = /[\\/]/.test(certPath);
            return !certPath || !looksLikeServerPath || !certPass;
          });
          if (invalidCertEmp) {
            alert(`A empresa "${invalidCertEmp.nome || invalidCertEmp.cnpj || "selecionada"}" está em modo Certificado A1 sem certificado/senha válidos no servidor. Edite a empresa e reenvie o arquivo .pfx/.p12.`);
            return;
          }

          const dataInicio = document.getElementById("loteDataInicio")?.value || "";
          const dataFim = document.getElementById("loteDataFim")?.value || "";
          const tipos = {
            recebidas: !!document.getElementById("loteTipoRecebidas")?.checked,
            emitidas: !!document.getElementById("loteTipoEmitidas")?.checked,
            canceladas: !!document.getElementById("loteTipoCanceladas")?.checked,
          };
          const formato = document.getElementById("loteFormato")?.value || "PDF + XML";

          if (!dataInicio || !dataFim) { alert("Informe Data Início e Data Fim."); return; }
          if (!tipos.recebidas && !tipos.emitidas && !tipos.canceladas) { alert("Selecione pelo menos um tipo de nota."); return; }

          const capturaUnica = empresas.length === 1;
          const fila = loadList(KEY_FILA);
          const jobId = `job_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          fila.unshift({
            id: jobId,
            tipo: capturaUnica ? "captura_individual" : "captura_lote",
            status: "na_fila",
            createdAt: nowISO(),
            empresas: empresas.map((e) => ({ id: e.id, nome: e.nome, cnpj: e.cnpj })),
            filtros: { dataInicio, dataFim, tipos, formato },
          });
          saveList(KEY_FILA, fila);

          const hist = loadList(KEY_HIST);
          hist.unshift({
            id: `log_${Date.now()}_${Math.random().toString(16).slice(2)}`,
            level: "Info",
            tipo: capturaUnica ? "captura_individual" : "captura_lote",
            status: "info",
            createdAt: nowISO(),
            message: capturaUnica
              ? `Captura individual solicitada para ${empresas[0]?.nome || "empresa"}`
              : `Captura em lote solicitada para ${empresas.length} empresa(s)`,
            meta: { dataInicio, dataFim, tipos, formato },
          });
          saveList(KEY_HIST, hist);

          const processarTipos = [];
          if (tipos.recebidas) processarTipos.push("recebidas");
          if (tipos.emitidas) processarTipos.push("emitidas");
          if (tipos.canceladas) processarTipos.push("canceladas");
          const baixarXml = (formato || "").toLowerCase().includes("somente pdf") ? false : true;
          const baixarPdf = (formato || "").toLowerCase().includes("somente xml") ? false : true;

          const oldLoteLabel = labelCapturarLote?.textContent || "Capturar";
          btnCapturarLote.disabled = true;
          btnCapturarLote.classList.add("opacity-70");
          if (labelCapturarLote) labelCapturarLote.textContent = "Capturando...";

          try {
            let data = null;
            if (capturaUnica) {
              const emp = empresas[0];
              data = await executarCapturaIndividualServidor(emp, { dataInicio, dataFim, tipos, formato });
            } else {
              const res = await fetch("/api/nf/lote", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  dataInicial: dataInicio,
                  dataFinal: dataFim,
                  tipoNota: processarTipos[0] || "emitidas",
                  processarTipos,
                  baixarXml,
                  baixarPdf,
                  pastaDestino: "downloads",
                  empresas: empresas.map((e) => ({
                    id: e.id, nome: e.nome, cnpj: e.cnpj,
                    loginPortal: e.portalLogin || e.loginPortal || "",
                    senhaPortal: e.portalSenha || e.senhaPortal || "",
                    authType: e.authType || "Login e Senha",
                    certPfxPath: e.certPfxPath || e.pfxPath || e.certFile || null,
                    certPassphrase: e.certPassphrase || e.passphrase || e.certPass || null,
                  })),
                }),
              });
              data = await res.json().catch(() => ({}));
              if (!res.ok || !data?.success) throw new Error(data?.error || `Falha no lote (${res.status})`);
            }

            if (data?.downloadZipUrl) {
              baixarZip(data.downloadZipUrl);
              addDownloadRecord({
                tipo: capturaUnica ? "captura_individual" : "captura_lote",
                empresa: capturaUnica ? (empresas[0]?.nome || "empresa") : `${empresas.length} empresa(s)`,
                zipUrl: data.downloadZipUrl,
              });
            }
            hist.unshift({
              id: `log_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              level: "Sucesso",
              tipo: capturaUnica ? "captura_individual" : "captura_lote",
              status: "concluida",
              createdAt: nowISO(),
              message: capturaUnica
                ? `Captura concluída para ${empresas[0]?.nome || "empresa"}`
                : `Captura em lote concluída para ${empresas.length} empresa(s)`,
              meta: { rawLogs: Array.isArray(data?.logs) ? data.logs : [] },
            });
            saveList(KEY_HIST, hist);
            if (fila[0] && fila[0].id === jobId) fila[0].status = "concluida";
            saveList(KEY_FILA, fila);
            alert(data?.downloadZipUrl ? "Captura concluída. Download do ZIP iniciado." : "Captura concluída no servidor.");
          } catch (err) {
            const msg = err?.message || "Erro ao executar captura.";
            hist.unshift({
              id: `log_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              level: "Erro",
              tipo: capturaUnica ? "captura_individual" : "captura_lote",
              status: "erro",
              createdAt: nowISO(),
              message: capturaUnica ? `Falha na captura individual: ${msg}` : `Falha na captura em lote: ${msg}`,
              meta: { rawLogs: [] },
            });
            saveList(KEY_HIST, hist);
            if (fila[0] && fila[0].id === jobId) fila[0].status = "erro";
            saveList(KEY_FILA, fila);
            alert(msg);
          } finally {
            if (labelCapturarLote) labelCapturarLote.textContent = oldLoteLabel;
            updateKPIsFromStorage();
            renderFila();
            renderHistoricoFromStorage();
            renderDownloads();
            updateCapturaLoteButton();
          }
        });
      }
      // ✅ CAPTURA INDIVIDUAL (Base44) — NOVO (somente esta parte)
      // =========================
      const ciEmpresa = document.getElementById("ciEmpresa");
      const ciDataInicio = document.getElementById("ciDataInicio");
      const ciDataFim = document.getElementById("ciDataFim");
      const ciTipoRecebidas = document.getElementById("ciTipoRecebidas");
      const ciTipoEmitidas = document.getElementById("ciTipoEmitidas");
      const ciTipoCanceladas = document.getElementById("ciTipoCanceladas");
      const ciFormato = document.getElementById("ciFormato");
      const btnCapturarIndividual = document.getElementById("btnCapturarIndividual");

      function renderCapturaIndividualEmpresas() {
        if (!ciEmpresa) return;

        const current = ciEmpresa.value || "";
        const list = loadEmpresas();

        ciEmpresa.innerHTML = `<option value="">Selecione a empresa</option>`;
        for (const emp of list) {
          const opt = document.createElement("option");
          opt.value = emp.id;
          opt.textContent = emp.nome ? `${emp.nome}` : (emp.cnpj || "Empresa");
          ciEmpresa.appendChild(opt);
        }

        // tenta manter seleÃƒÂ§ÃƒÂ£o
        if (current) ciEmpresa.value = current;

        updateCapturaIndividualButton();
      }

      function getTiposCapturaIndividual() {
        const tipos = {
          recebidas: !!ciTipoRecebidas?.checked,
          emitidas: !!ciTipoEmitidas?.checked,
          canceladas: !!ciTipoCanceladas?.checked,
        };
        return tipos;
      }

      
      function mapTiposParaProcessar(tipos) {
        const arr = [];
        if (tipos.recebidas) arr.push("recebidas");
        if (tipos.emitidas) arr.push("emitidas");
        if (tipos.canceladas) arr.push("canceladas");
        return arr;
      }

      function mapFormatoDownload(formato) {
        const f = (formato || "").toLowerCase();
        if (f.includes("somente xml")) return { baixarXml: true, baixarPdf: false };
        if (f.includes("somente pdf")) return { baixarXml: false, baixarPdf: true };
        return { baixarXml: true, baixarPdf: true };
      }

      function baixarZip(url) {
        if (!url) return;
        const a = document.createElement("a");
        a.href = url;
        a.download = "";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      async function executarCapturaIndividualServidor(emp, filtros) {
        const tiposSelecionados = mapTiposParaProcessar(filtros.tipos);
        const authType = (emp.authType || "Login e Senha").toString();
        const isCert = authType.toLowerCase().includes("certificado");

        const login = (emp.portalLogin || emp.loginPortal || "").toString().trim();
        const senha = (emp.portalSenha || emp.senhaPortal || "").toString();
        const certPfxPath = emp.certPfxPath || emp.pfxPath || emp.certFile || null;
        const certPassphrase = emp.certPassphrase || emp.passphrase || emp.certPass || null;

        if (!isCert && (!login || !senha)) {
          throw new Error("Empresa sem login/senha do portal. Cadastre as credenciais para capturar.");
        }
        if (isCert && (!certPfxPath || !certPassphrase)) {
          throw new Error("Empresa em modo Certificado Digital (A1) sem arquivo/senha do certificado. Edite a empresa e configure o A1.");
        }

        const formatos = mapFormatoDownload(filtros.formato);
        const payload = {
          dataInicial: filtros.dataInicio,
          dataFinal: filtros.dataFim,
          tipoNota: tiposSelecionados[0] || "emitidas",
          processarTipos: tiposSelecionados,
          baixarXml: formatos.baixarXml,
          baixarPdf: formatos.baixarPdf,
          pastaDestino: "downloads",
          login,
          senha,
          empresaId: emp.id,
          empresaNome: emp.nome || "",
          empresaCnpj: emp.cnpj || "",
          usuarioEmail: currentUser?.email || "",
          authType,
          usarCertificadoA1: isCert,
          certPfxPath,
          certPassphrase,
        };

        const res = await fetch("/api/nf/manual", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) {
          throw new Error(data?.error || `Falha na captura (${res.status})`);
        }

        return data;
      }

      function hasAnyTipo(tipos) {
        return !!(tipos.recebidas || tipos.emitidas || tipos.canceladas);
      }

      function updateCapturaIndividualButton() {
        if (!btnCapturarIndividual) return;

        const empresaOk = !!(ciEmpresa && ciEmpresa.value);
        const di = (ciDataInicio?.value || "").trim();
        const df = (ciDataFim?.value || "").trim();
        const datasOk = !!(di && df);
        const tipos = getTiposCapturaIndividual();
        const tiposOk = hasAnyTipo(tipos);

        const ok = empresaOk && datasOk && tiposOk;

        btnCapturarIndividual.disabled = !ok;
        btnCapturarIndividual.classList.toggle("opacity-70", !ok);
      }

      [ciEmpresa, ciDataInicio, ciDataFim, ciTipoRecebidas, ciTipoEmitidas, ciTipoCanceladas, ciFormato]
        .filter(Boolean)
        .forEach((el) => el.addEventListener("change", updateCapturaIndividualButton));

      if (btnCapturarIndividual) {
        btnCapturarIndividual.addEventListener("click", async () => {
          const empresaId = (ciEmpresa?.value || "").trim();
          if (!empresaId) return;

          const emp = loadEmpresas().find((e) => e.id === empresaId);
          if (!emp) {
            alert("Empresa inválida. Selecione novamente.");
            return;
          }

          const dataInicio = (ciDataInicio?.value || "").trim();
          const dataFim = (ciDataFim?.value || "").trim();
          const tipos = getTiposCapturaIndividual();
          const formato = (ciFormato?.value || "PDF + XML").trim();

          if (!dataInicio || !dataFim) {
            alert("Informe Data Início e Data Fim.");
            return;
          }
          if (!hasAnyTipo(tipos)) {
            alert("Selecione pelo menos um tipo de nota.");
            return;
          }

          // enfileira (front)
          const fila = loadList(KEY_FILA);
          const jobId = `job_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          fila.unshift({
            id: jobId,
            tipo: "captura_individual",
            status: "na_fila",
            createdAt: nowISO(),
            empresas: [{ id: emp.id, nome: emp.nome, cnpj: emp.cnpj }],
            filtros: { dataInicio, dataFim, tipos, formato },
          });
          saveList(KEY_FILA, fila);

          // log
          const hist = loadList(KEY_HIST);
          hist.unshift({
            id: `log_${Date.now()}_${Math.random().toString(16).slice(2)}`,
            level: "Info",
            tipo: "captura_individual",
            status: "info",
            createdAt: nowISO(),
            message: `Captura individual solicitada para ${emp.nome || "empresa"}`,
            meta: { empresaId: emp.id, empresaNome: emp.nome, empresaCnpj: emp.cnpj, dataInicio, dataFim, tipos, formato },
          });
          saveList(KEY_HIST, hist);

          const labelEl = document.getElementById("labelCapturarIndividual");
          const oldLabel = labelEl ? labelEl.textContent : "Iniciar Captura";
          btnCapturarIndividual.disabled = true;
          btnCapturarIndividual.classList.add("opacity-70");
          if (labelEl) labelEl.textContent = "Capturando...";

          try {
            const result = await executarCapturaIndividualServidor(emp, {
              dataInicio,
              dataFim,
              tipos,
              formato,
            });

            if (result.downloadZipUrl) {
              baixarZip(result.downloadZipUrl);
              addDownloadRecord({
                tipo: "captura_individual",
                empresa: emp.nome || "empresa",
                zipUrl: result.downloadZipUrl,
              });
            }

            hist.unshift({
              id: `log_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              level: "Sucesso",
              tipo: "captura_individual",
              status: "concluida",
              createdAt: nowISO(),
              message: `Captura concluída para ${emp.nome || "empresa"}`,
              meta: {
                empresaId: emp.id,
                downloadZipUrl: result.downloadZipUrl || null,
                rawLogs: Array.isArray(result?.logs) ? result.logs : [],
              },
            });
            saveList(KEY_HIST, hist);

            if (fila[0] && fila[0].id === jobId) fila[0].status = "concluida";
            saveList(KEY_FILA, fila);

            alert(result.downloadZipUrl ? "Captura concluída. Download do ZIP iniciado." : "Captura concluída no servidor.");
          } catch (err) {
            const msg = err?.message || "Erro ao executar captura.";
            hist.unshift({
              id: `log_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              level: "Erro",
              tipo: "captura_individual",
              status: "erro",
              createdAt: nowISO(),
              message: `Falha na captura individual: ${msg}`,
              meta: { empresaId: emp.id, rawLogs: [] },
            });
            saveList(KEY_HIST, hist);

            if (fila[0] && fila[0].id === jobId) fila[0].status = "erro";
            saveList(KEY_FILA, fila);

            alert(msg);
          } finally {
            if (labelEl) labelEl.textContent = oldLabel || "Iniciar Captura";
            updateKPIsFromStorage();
            renderFila();
            renderHistoricoFromStorage();
            renderDownloads();
            updateCapturaIndividualButton();
          }
        });
      }
      // Fila (render simples)
      const filaContainer = document.getElementById("filaContainer");
      const btnAtualizarFila = document.getElementById("btnAtualizarFila");
      const btnLimparFila = document.getElementById("btnLimparFila");
      function renderFila() {
        if (!filaContainer) return;
        const fila = loadList(KEY_FILA);

        if (!fila.length) {
          filaContainer.innerHTML = `
            <div class="w-full">
              <div class="mb-4 flex items-center justify-end gap-2">
                <button id="btnLimparFila" class="btn-ghost px-4 py-2 rounded-xl2 text-sm opacity-70" disabled>Excluir dados</button>
                <button id="btnAtualizarFila" class="btn-ghost px-4 py-2 rounded-xl2 text-sm flex items-center gap-2">
                  <span class="text-white/70">↻</span> Atualizar
                </button>
              </div>
              <div class="text-center text-white/45 py-8">
                <div class="mx-auto mb-3 text-white/35">
                  <svg width="34" height="34" viewBox="0 0 24 24" fill="none">
                    <path d="M6 7h12M6 12h12M6 17h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 7h.01M4 12h.01M4 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                  </svg>
                </div>
                <p class="text-sm">Nenhuma captura na fila</p>
              </div>
            </div>
          `;
          bindFilaActions();
          return;
        }

        filaContainer.innerHTML = `
          <div class="w-full">
            <div class="mb-4 flex items-center justify-end gap-2">
              <button id="btnLimparFila" class="btn-ghost px-4 py-2 rounded-xl2 text-sm" style="border-color: rgba(239,68,68,.25); color: rgba(239,68,68,.95);">Excluir dados</button>
              <button id="btnAtualizarFila" class="btn-ghost px-4 py-2 rounded-xl2 text-sm flex items-center gap-2">
                <span class="text-white/70">↻</span> Atualizar
              </button>
            </div>
            <div class="space-y-3">
            ${fila
              .map((j, idx) => {
                const empresas = (j.empresas || []).map((e) => e.nome).join(", ");
                return `
                  <div class="glass-strong rounded-xl2 p-5">
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <p class="text-sm font-semibold text-white/85">${
                          j.tipo === "captura_lote" ? "Captura em Lote" : j.tipo === "captura_individual" ? "Captura Individual" : "Captura"
                        }</p>
                        <p class="text-xs text-white/45 mt-1">${empresas || "-"}</p>
                        <p class="text-xs text-white/35 mt-2">Status: ${j.status || "-"}</p>
                      </div>
                      <div class="text-right">
                        <span class="text-xs text-white/45 block">${(j.createdAt || "").toString().slice(0, 16).replace("T", " ")}</span>
                        <button class="btn-ghost mt-2 px-3 py-1 rounded-xl2 text-xs" data-fila-action="delete" data-fila-idx="${idx}" style="border-color: rgba(239,68,68,.25); color: rgba(239,68,68,.95);">Excluir</button>
                      </div>
                    </div>
                  </div>
                `;
              })
              .join("")}
            </div>
          </div>
        `;
        bindFilaActions();
      }
      function bindFilaActions() {
        const btnAtualizar = document.getElementById("btnAtualizarFila");
        if (btnAtualizar && !btnAtualizar.dataset.bound) {
          btnAtualizar.dataset.bound = "1";
          btnAtualizar.addEventListener("click", () => renderFila());
        }
        const btnLimpar = document.getElementById("btnLimparFila");
        if (btnLimpar && !btnLimpar.dataset.bound) {
          btnLimpar.dataset.bound = "1";
          btnLimpar.addEventListener("click", () => {
            saveList(KEY_FILA, []);
            updateKPIsFromStorage();
            renderFila();
          });
        }
      }

      if (filaContainer && !filaContainer.dataset.bound) {
        filaContainer.dataset.bound = "1";
        filaContainer.addEventListener("click", (ev) => {
          const btn = ev.target.closest("button[data-fila-action][data-fila-idx]");
          if (!btn) return;
          const action = btn.getAttribute("data-fila-action");
          const idx = Number(btn.getAttribute("data-fila-idx"));
          if (action === "delete" && Number.isInteger(idx) && idx >= 0) {
            const fila = loadList(KEY_FILA);
            fila.splice(idx, 1);
            saveList(KEY_FILA, fila);
            updateKPIsFromStorage();
            renderFila();
          }
        });
      }

      // HistÃƒÂ³rico (se tiver logs no storage, usa)
      function renderHistoricoFromStorage(force = false) {
        const histView = document.getElementById("view-historico");
        if (!force && histView?.classList.contains("hidden")) return;

        const listEl = document.getElementById("historicoList");
        if (!listEl) return;
        const qEl = document.getElementById("historicoSearch");
        const filtroEl = document.getElementById("historicoFiltro");
        const q = String(qEl?.value || "").trim().toLowerCase();
        const filtro = String(filtroEl?.value || "Todos").trim().toLowerCase();

        const hist = loadList(KEY_HIST);
        if (!hist.length) {
          listEl.innerHTML = `
            <div class="glass-strong rounded-xl2 p-5 text-center text-white/55">
              Nenhum log registrado ainda.
            </div>
          `;
          return;
        }

        const filtered = hist
          .filter((x) => {
            const level = String(x?.level || "Info").toLowerCase();
            if (filtro !== "todos" && level !== filtro) return false;
            if (!q) return true;
            const msg = String(x?.message || "").toLowerCase();
            const tipo = String(x?.tipo || "").toLowerCase();
            const meta = JSON.stringify(x?.meta || {}).toLowerCase();
            return msg.includes(q) || tipo.includes(q) || meta.includes(q) || level.includes(q);
          })
          .slice(0, 200);

        if (!filtered.length) {
          listEl.innerHTML = `
            <div class="glass-strong rounded-xl2 p-5 text-center text-white/55">
              Nenhum log encontrado para este filtro.
            </div>
          `;
          return;
        }

        listEl.innerHTML = filtered
          .map((x) => {
            const level = x.level || "Info";
            const levelStyle =
              level === "Sucesso"
                ? "background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.28);"
                : level === "Erro"
                ? "background: rgba(239,68,68,.14); border:1px solid rgba(239,68,68,.28);"
                : "background: rgba(59,130,246,.14); border:1px solid rgba(59,130,246,.28);";

            const logs = Array.isArray(x?.meta?.rawLogs) ? x.meta.rawLogs : [];
            const hasLogs = logs.length > 0;
            const logsText = logs.join("\n");

            return `
              <div class="glass-strong rounded-xl2 p-5">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold" style="${levelStyle}">${level}</span>
                    <div>
                      <p class="text-sm font-semibold">${x.message || "-"}</p>
                      <p class="text-xs text-white/35 mt-2">${x.tipo || ""}</p>
                      ${
                        hasLogs
                          ? `<div class="mt-3 flex items-center gap-2">
                              <button class="btn-ghost px-3 py-1 rounded-xl2 text-xs" data-log-action="toggle" data-log-id="${x.id}">Ver logs</button>
                              <button class="btn-ghost px-3 py-1 rounded-xl2 text-xs" data-log-action="copy" data-log-id="${x.id}">Copiar logs</button>
                              <button class="btn-ghost px-3 py-1 rounded-xl2 text-xs" data-log-action="delete" data-log-id="${x.id}" style="border-color: rgba(239,68,68,.25); color: rgba(239,68,68,.95);">Excluir</button>
                            </div>
                            <pre id="log-full-${x.id}" class="hidden mt-3 p-3 rounded-xl2 text-xs whitespace-pre-wrap bg-black/25 border border-white/10 max-h-[220px] overflow-auto">${logsText}</pre>`
                          : `<div class="mt-3 flex items-center gap-2">
                              <button class="btn-ghost px-3 py-1 rounded-xl2 text-xs" data-log-action="delete" data-log-id="${x.id}" style="border-color: rgba(239,68,68,.25); color: rgba(239,68,68,.95);">Excluir</button>
                            </div>`
                      }
                    </div>
                  </div>
                  <span class="text-xs text-white/45">${(x.createdAt || "").toString().slice(0, 19).replace("T", " ")}</span>
                </div>
              </div>
            `;
          })
          .join("");
      }

      const historicoList = document.getElementById("historicoList");
      if (historicoList && !historicoList.dataset.bound) {
        historicoList.dataset.bound = "1";
        historicoList.addEventListener("click", async (ev) => {
          const btn = ev.target.closest("button[data-log-action][data-log-id]");
          if (!btn) return;
          const action = btn.getAttribute("data-log-action");
          const logId = btn.getAttribute("data-log-id");
          const pre = document.getElementById(`log-full-${logId}`);

          if (action === "toggle") {
            if (!pre) return;
            pre.classList.toggle("hidden");
            btn.textContent = pre.classList.contains("hidden") ? "Ver logs" : "Ocultar logs";
            return;
          }

          if (action === "copy") {
            if (!pre) return;
            try {
              await navigator.clipboard.writeText(pre.textContent || "");
              btn.textContent = "Copiado";
              setTimeout(() => (btn.textContent = "Copiar logs"), 1200);
            } catch (e) {
              btn.textContent = "Falha ao copiar";
              setTimeout(() => (btn.textContent = "Copiar logs"), 1200);
            }
            return;
          }

          if (action === "delete") {
            const hist = loadList(KEY_HIST).filter((x) => String(x?.id) !== String(logId));
            saveList(KEY_HIST, hist);
            updateKPIsFromStorage();
            renderHistoricoFromStorage(true);
          }
        });
      }

      const historicoSearch = document.getElementById("historicoSearch");
      const historicoFiltro = document.getElementById("historicoFiltro");
      if (historicoSearch && !historicoSearch.dataset.bound) {
        historicoSearch.dataset.bound = "1";
        historicoSearch.addEventListener("input", () => renderHistoricoFromStorage(true));
      }
      if (historicoFiltro && !historicoFiltro.dataset.bound) {
        historicoFiltro.dataset.bound = "1";
        historicoFiltro.addEventListener("change", () => renderHistoricoFromStorage(true));
      }

      // view inicial
      showView("view-dashboard");

      // init: empresas / lote / ✅ individual / kpis / fila
      (function init() {
        renderEmpresas();
        renderLoteEmpresas();
        renderCapturaIndividualEmpresas();
        updateKPIsFromStorage();
        renderFila();
        renderDownloads();
        renderHistoricoFromStorage();
        updateCapturaIndividualButton();
      })();
    </script>

    <!-- ✅ Se você já tem scripts do sistema, mantém aqui (opcional)
         <script src="/js/dashboard.js" defer></script>
         <script src="/js/historico.js" defer></script>
         <script src="/js/emissao.js" defer></script>
    -->
  </body>
</html>
